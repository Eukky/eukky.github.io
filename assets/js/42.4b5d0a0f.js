(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{366:function(t,a,n){"use strict";n.r(a);var s=n(14),e=Object(s.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"ue5中的卡通渲染-自定义shading-model"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ue5中的卡通渲染-自定义shading-model"}},[t._v("#")]),t._v(" UE5中的卡通渲染——自定义Shading Model")]),t._v(" "),a("p",[t._v("虽然距离上一次投稿已经过去了好久，在这段时间里面，我也尝试了去用UE5自定义一些渲染管线来实现卡通渲染，虽然知乎上已经有非常多的大佬已经讲过了这些东西，但是由于我的开发分支是跟随着ue5-main的分支一起开发的，期间还是遇到了一些别人文章中没有遇到的坑。如果有小伙伴也想实时跟随着官方的进度一起在主开发分支进行开发，在开发的同时能够第一时间尝鲜到官方制作的新功能以及新Bug，那么可以参考一下，我遇到的坑里面，有没有一些对你能够产生帮助的东西。")]),t._v(" "),a("h2",{attrs:{id:"shading-model的简单原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#shading-model的简单原理"}},[t._v("#")]),t._v(" Shading Model的简单原理")]),t._v(" "),a("p",[t._v("开发一个新的着色模型最直接的方式就是去添加一个自定义的Shading Model了。由于知乎上已经有太多的文章直接展示了如何去扩展一个Shading Model的代码，我在实践的过程中也参考了其中不少，但是鲜有文章能够简单的讲解一下UE的内部一个Shading Model是如何生效的，其中的原理又分为哪几步，那么这里就基于我自己的实践简单讲讲吧。")]),t._v(" "),a("p",[t._v("一个Shading Model需要生效，到最终在材质中去表现出来，简单来说需要以下这么几步")]),t._v(" "),a("ol",[a("li",[t._v("在母材质中选中需要使用的Shading Model")]),t._v(" "),a("li",[t._v("在选中之后，该Shading Model的值会被传入到材质的输入参数"),a("code",[t._v("PixelMaterialInputs")]),t._v("中，以便在PS中获取这个参数")]),t._v(" "),a("li",[t._v("由于是延迟渲染，同时，该Shading Model的值也会通过"),a("code",[t._v("SetGBufferForShadingModel")]),t._v("函数被传入到GBuffer")]),t._v(" "),a("li",[t._v("在处理完参数的输入之后，最终在光照计算的"),a("code",[t._v("IntegrateBxDF")]),t._v("函数里面根据传入的Shading Model的值来选择对应的BxDF函数来进行光照计算")]),t._v(" "),a("li",[t._v("最后就是执行我们自定义的BxDF的光照计算了")])]),t._v(" "),a("p",[t._v("通过上述步骤，就可以让一个Shading Model所定义的光照计算最终被材质调用，在画面中表现出来。")]),t._v(" "),a("h2",{attrs:{id:"shading-model的开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#shading-model的开发"}},[t._v("#")]),t._v(" Shading Model的开发")]),t._v(" "),a("p",[t._v("理清了上述步骤，Shading Model的开发步骤已经变得非常清晰。")]),t._v(" "),a("p",[t._v("首先需要在母材质的编辑器中添加我们新的Shading Model选项，只需要在"),a("code",[t._v("EMaterialShadingModel")]),t._v("中添加对应的枚举值即可")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('//EngineTypes.h\nUENUM()\nenum EMaterialShadingModel : int\n{\n\tMSM_Unlit\t\t\t\t\tUMETA(DisplayName="Unlit"),\n\tMSM_DefaultLit\t\t\t\tUMETA(DisplayName="Default Lit"),\n\tMSM_Subsurface\t\t\t\tUMETA(DisplayName="Subsurface"),\n\tMSM_PreintegratedSkin\t\tUMETA(DisplayName="Preintegrated Skin"),\n\tMSM_ClearCoat\t\t\t\tUMETA(DisplayName="Clear Coat"),\n\tMSM_SubsurfaceProfile\t\tUMETA(DisplayName="Subsurface Profile"),\n\tMSM_TwoSidedFoliage\t\t\tUMETA(DisplayName="Two Sided Foliage"),\n\tMSM_Hair\t\t\t\t\tUMETA(DisplayName="Hair"),\n\tMSM_Cloth\t\t\t\t\tUMETA(DisplayName="Cloth"),\n\tMSM_Eye\t\t\t\t\t\tUMETA(DisplayName="Eye"),\n\tMSM_SingleLayerWater\t\tUMETA(DisplayName="SingleLayerWater"),\n\tMSM_ThinTranslucent\t\t\tUMETA(DisplayName="Thin Translucent"),\n\tMSM_Strata\t\t\t\t\tUMETA(DisplayName="Strata", Hidden),\n\tMSM_Toon\t\t\t\t\tUMETA(DisplayName="Toon"),\n\t/** Number of unique shading models. */\n\tMSM_NUM\t\t\t\t\t\tUMETA(Hidden),\n\t/** Shading model will be determined by the Material Expression Graph,\n\t\tby utilizing the \'Shading Model\' MaterialAttribute output pin. */\n\tMSM_FromMaterialExpression\tUMETA(DisplayName="From Material Expression"),\n\tMSM_MAX\n};\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br")])]),a("p",[t._v("增加了定义之后，一切都变得简单了起来，俗话说的好，UE的开发就是照葫芦画瓢，我们只需要随意在上面选择另外一个Shading Model，然后全局搜索，在搜索结果中照抄就好。")]),t._v(" "),a("p",[t._v("添加枚举转字符串")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('//MaterialShader.cpp\nFString GetShadingModelString(EMaterialShadingModel ShadingModel)\n{\n\tFString ShadingModelName;\n\tswitch(ShadingModel)\n\t{\n\t\tcase MSM_Unlit:\t\t\t\tShadingModelName = TEXT("MSM_Unlit"); break;\n\t\tcase MSM_DefaultLit:\t\tShadingModelName = TEXT("MSM_DefaultLit"); break;\n\t\tcase MSM_Subsurface:\t\tShadingModelName = TEXT("MSM_Subsurface"); break;\n\t\tcase MSM_PreintegratedSkin:\tShadingModelName = TEXT("MSM_PreintegratedSkin"); break;\n\t\tcase MSM_ClearCoat:\t\t\tShadingModelName = TEXT("MSM_ClearCoat"); break;\n\t\tcase MSM_SubsurfaceProfile:\tShadingModelName = TEXT("MSM_SubsurfaceProfile"); break;\n\t\tcase MSM_TwoSidedFoliage:\tShadingModelName = TEXT("MSM_TwoSidedFoliage"); break;\n\t\tcase MSM_Hair:\t\t\t\tShadingModelName = TEXT("MSM_Hair"); break;\n\t\tcase MSM_Cloth:\t\t\t\tShadingModelName = TEXT("MSM_Cloth"); break;\n\t\tcase MSM_Eye:\t\t\t\tShadingModelName = TEXT("MSM_Eye"); break;\n\t\tcase MSM_SingleLayerWater:\tShadingModelName = TEXT("MSM_SingleLayerWater"); break;\n\t\tcase MSM_ThinTranslucent:\tShadingModelName = TEXT("MSM_ThinTranslucent"); break;\n\t\tcase MSM_Toon:\t\t\t\tShadingModelName = TEXT("MSM_Toon"); break;\n\t\tdefault: ShadingModelName = TEXT("Unknown"); break;\n\t}\n\treturn ShadingModelName;\n}\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br")])]),a("p",[t._v("添加Shader中的宏定义")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('//HLSLMaterialTranslator.cpp\nif (ShadingModels.HasShadingModel(MSM_SingleLayerWater))\n{\n    OutEnvironment.SetDefine(TEXT("MATERIAL_SHADINGMODEL_SINGLELAYERWATER"), TEXT("1"));\n    NumSetMaterials++;\n}\nif (ShadingModels.HasShadingModel(MSM_ThinTranslucent))\n{\n    OutEnvironment.SetDefine(TEXT("MATERIAL_SHADINGMODEL_THIN_TRANSLUCENT"), TEXT("1"));\n    NumSetMaterials++;\n\n    bMaterialRequestsDualSourceBlending = true;\n}\n\nif (ShadingModels.HasShadingModel(MSM_Toon)) \n{\n    OutEnvironment.SetDefine(TEXT("MATERIAL_SHADINGMODEL_TOON"), TEXT("1"));\n    NumSetMaterials++;\n}\n\nif (ShadingModels.HasShadingModel(MSM_SingleLayerWater) && FDataDrivenShaderPlatformInfo::GetRequiresDisableForwardLocalLights(Platform))\n{\n    OutEnvironment.SetDefine(TEXT("DISABLE_FORWARD_LOCAL_LIGHTS"), TEXT("1"));\n}\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br")])]),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShaderMaterial.h\nstruct FShaderMaterialPropertyDefines\n{\n\t//DECLARE_TYPE_LAYOUT(FShaderMaterialPropertyDefines, NonVirtual);\n\n\t//void ModifyEnvironment(FShaderCompilerEnvironment& OutEnvironment) const;\n\t//void WriteFrozenVertexFactoryParameters(FMemoryImageWriter& Writer, const TMemoryImagePtr<FShaderMaterialPropertyDefines>& InPropDefines) const;\n\n\tuint8 MATERIAL_ENABLE_TRANSLUCENCY_FOGGING : 1;\n\n\tuint8 MATERIALBLENDING_ANY_TRANSLUCENT : 1;\n\tuint8 MATERIAL_USES_SCENE_COLOR_COPY : 1;\n\tuint8 MATERIALBLENDING_MASKED_USING_COVERAGE : 1;\n\n\tuint8 MATERIAL_COMPUTE_FOG_PER_PIXEL : 1;\n\tuint8 MATERIAL_SHADINGMODEL_UNLIT : 1;\n\n\tuint8 MATERIAL_SHADINGMODEL_DEFAULT_LIT : 1;\n\tuint8 MATERIAL_SHADINGMODEL_SUBSURFACE : 1;\n\tuint8 MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN : 1;\n\tuint8 MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE : 1;\n\tuint8 MATERIAL_SHADINGMODEL_CLEAR_COAT : 1;\n\tuint8 MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE : 1;\n\tuint8 MATERIAL_SHADINGMODEL_HAIR : 1;\n\tuint8 MATERIAL_SHADINGMODEL_CLOTH : 1;\n\tuint8 MATERIAL_SHADINGMODEL_EYE : 1;\n\tuint8 MATERIAL_SHADINGMODEL_SINGLELAYERWATER : 1;\n\tuint8 SINGLE_LAYER_WATER_SEPARATED_MAIN_LIGHT : 1;\n\tuint8 MATERIAL_SHADINGMODEL_THIN_TRANSLUCENT : 1;\n\n\tuint8 MATERIAL_SHADINGMODEL_TOON : 1;\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br")])]),a("p",[t._v("添加Shader生成代码")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShaderGenerationUtil.cpp\nvoid FShaderCompileUtilities::ApplyFetchEnvironment(FShaderMaterialPropertyDefines& SrcDefines, FShaderCompilerEnvironment& OutEnvironment)\n{\n\tFETCH_COMPILE_BOOL(MATERIAL_ENABLE_TRANSLUCENCY_FOGGING);\n\tFETCH_COMPILE_BOOL(MATERIALBLENDING_ANY_TRANSLUCENT);\n\tFETCH_COMPILE_BOOL(MATERIAL_USES_SCENE_COLOR_COPY);\n\tFETCH_COMPILE_BOOL(MATERIALBLENDING_MASKED_USING_COVERAGE);\n\n\tFETCH_COMPILE_BOOL(MATERIAL_COMPUTE_FOG_PER_PIXEL);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_UNLIT);\n\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_DEFAULT_LIT);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_SUBSURFACE);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_CLEAR_COAT);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_HAIR);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_CLOTH);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_EYE);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_SINGLELAYERWATER);\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_THIN_TRANSLUCENT);\n\n\tFETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_TOON);\n\n\tFETCH_COMPILE_BOOL(SINGLE_LAYER_WATER_SEPARATED_MAIN_LIGHT);\n\n\tFETCH_COMPILE_BOOL(MATERIAL_FULLY_ROUGH);\n\n\tFETCH_COMPILE_BOOL(USES_EMISSIVE_COLOR);\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br")])]),a("p",[t._v("如果我们的Shader Model需要使用额外的的数据，也可以将这些参数通过CustomData进行传入，同时修改材质节点的引脚")]),t._v(" "),a("p",[t._v("在该Shading Model下激活Custom引脚")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//Material.cpp\ncase MP_Normal:\n    Active = (ShadingModels.IsLit() && (!bIsTranslucentBlendMode || !bIsNonDirectionalTranslucencyLightingMode)) || bUsesDistortion;\n    break;\ncase MP_Tangent:\n    Active = ShadingModels.HasAnyShadingModel({ MSM_DefaultLit, MSM_ClearCoat }) && (!bIsTranslucentBlendMode || !bIsVolumetricTranslucencyLightingMode);\n    break;\ncase MP_SubsurfaceColor:\n    Active = ShadingModels.HasAnyShadingModel({ MSM_Subsurface, MSM_PreintegratedSkin, MSM_TwoSidedFoliage, MSM_Cloth });\n    break;\ncase MP_CustomData0:\n    Active = ShadingModels.HasAnyShadingModel({ MSM_ClearCoat, MSM_Hair, MSM_Cloth, MSM_Eye, MSM_SubsurfaceProfile, MSM_Toon });\n    break;\ncase MP_CustomData1:\n    Active = ShadingModels.HasAnyShadingModel({ MSM_ClearCoat, MSM_Eye, MSM_Toon });\n    break;\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("p",[t._v("增加新的引脚，这段代码原本是放在MaterialShared.cpp文件下，但是目前主开发分支最新的版本已经把这些都移到了MaterialAttributeDefinitionMap.cpp下面（导致我合代码时不注意，导致疯狂报重定义编译失败）")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('//MaterialShared.cpp/MaterialAttributeDefinitionMap.cpp\ncase MP_CustomData0:\t\n    CustomPinNames.Add({ MSM_ClearCoat, "Clear Coat" });\n    CustomPinNames.Add({MSM_Hair, "Backlit"});\n    CustomPinNames.Add({MSM_Cloth, "Cloth"});\n    CustomPinNames.Add({MSM_Eye, "Iris Mask"});\n    CustomPinNames.Add({MSM_SubsurfaceProfile, "Curvature" });\n\n    CustomPinNames.Add({ MSM_Toon, "Specular Range" });\n    return FText::FromString(GetPinNameFromShadingModelField(Material->GetShadingModels(), CustomPinNames, "Custom Data 0"));\ncase MP_CustomData1:\n    CustomPinNames.Add({ MSM_ClearCoat, "Clear Coat Roughness" });\n    CustomPinNames.Add({MSM_Eye, "Iris Distance"});\n  \n    CustomPinNames.Add({ MSM_Toon, "Offset" });\n    return FText::FromString(GetPinNameFromShadingModelField(Material->GetShadingModels(), CustomPinNames, "Custom Data 1"));\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("p",[t._v("将CustomData写入GBuffer")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShaderGenerationUtil.cpp\nif (Mat.MATERIAL_SHADINGMODEL_EYE)\n{\n    SetStandardGBufferSlots(Slots, bWriteEmissive, bHasTangent, bHasVelocity, bHasStaticLighting, bIsStrataMaterial);\n    Slots[GBS_CustomData] = bUseCustomData;\n}\n\nif (Mat.MATERIAL_SHADINGMODEL_SINGLELAYERWATER)\n{\n    // single layer water uses standard slots\n    SetStandardGBufferSlots(Slots, bWriteEmissive, bHasTangent, bHasVelocity, bHasStaticLighting, bIsStrataMaterial);\n    if (Mat.SINGLE_LAYER_WATER_SEPARATED_MAIN_LIGHT)\n    {\n        Slots[GBS_SeparatedMainDirLight] = true;\n    }\n}\n\n// doesn't write to GBuffer\nif (Mat.MATERIAL_SHADINGMODEL_THIN_TRANSLUCENT)\n{\n}\nif (Mat.MATERIAL_SHADINGMODEL_TOON)\n{\n    SetStandardGBufferSlots(Slots, bWriteEmissive, bHasTangent, bHasVelocity, bHasStaticLighting, bIsStrataMaterial);\n    Slots[GBS_CustomData] = bUseCustomData;\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br")])]),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShaderMaterialDerivedHelpers.cpp\nDst.NEEDS_LIGHTMAP = (Dst.NEEDS_LIGHTMAP_COORDINATE) && !Lightmap.PRECOMPUTED_IRRADIANCE_VOLUME_LIGHTING;\n\nDst.USES_GBUFFER = (FEATURE_LEVEL >= ERHIFeatureLevel::SM4_REMOVED && (Mat.MATERIALBLENDING_SOLID || Mat.MATERIALBLENDING_MASKED) && !SrcGlobal.FORWARD_SHADING);\n\n// Only some shader models actually need custom data.\nDst.WRITES_CUSTOMDATA_TO_GBUFFER = (Dst.USES_GBUFFER && (Mat.MATERIAL_SHADINGMODEL_SUBSURFACE || Mat.MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN || Mat.MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE || Mat.MATERIAL_SHADINGMODEL_CLEAR_COAT || Mat.MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE || Mat.MATERIAL_SHADINGMODEL_HAIR || Mat.MATERIAL_SHADINGMODEL_CLOTH || Mat.MATERIAL_SHADINGMODEL_EYE || Mat.MATERIAL_SHADINGMODEL_TOON));\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("那么C++部分的改动到此基本就结束了，从结果来看，我们在材质编辑器中增加了一个Shading Model的选项，同时在选中这个Shading Model的时候，会出现两个自定义的引脚，这两个引脚会通过CustomData把参数传到Shader当中供我们在计算时候使用。")]),t._v(" "),a("p",[t._v("接下来时Shader的部分，首先同样是照葫芦画瓢，我们可以通过全局搜索其他Shading Model的名称，把一些定义先加上")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//Definitions.usf\n#if STRATA_NORMAL_QUALITY==0\n#define STRATA_TOP_LAYER_TYPE uint\n#elif STRATA_NORMAL_QUALITY==1\n#define STRATA_TOP_LAYER_TYPE uint2\n#else\n#error Uknown STRATA_NORMAL_QUALITY\n#endif\n\n#ifndef MATERIAL_SHADINGMODEL_DEFAULT_LIT\n#define MATERIAL_SHADINGMODEL_DEFAULT_LIT\t\t\t\t0\n#endif\n\n#ifndef MATERIAL_SHADINGMODEL_TOON\n#define MATERIAL_SHADINGMODEL_TOON\t\t\t\t\t\t0\n#endif\n\n#ifndef MATERIAL_SHADINGMODEL_SUBSURFACE\n#define MATERIAL_SHADINGMODEL_SUBSURFACE\t\t\t\t0\n#endif\n\n#ifndef MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN\n#define MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN\t\t0\n#endif\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br")])]),a("p",[t._v("添加Shading Model ID，同时定义在View中Debug的颜色")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShadingCommon.ush\n// SHADINGMODELID_* occupy the 4 low bits of an 8bit channel and SKIP_* occupy the 4 high bits\n#define SHADINGMODELID_UNLIT\t\t\t\t0\n#define SHADINGMODELID_DEFAULT_LIT\t\t\t1\n#define SHADINGMODELID_SUBSURFACE\t\t\t2\n#define SHADINGMODELID_PREINTEGRATED_SKIN\t3\n#define SHADINGMODELID_CLEAR_COAT\t\t\t4\n#define SHADINGMODELID_SUBSURFACE_PROFILE\t5\n#define SHADINGMODELID_TWOSIDED_FOLIAGE\t\t6\n#define SHADINGMODELID_HAIR\t\t\t\t\t7\n#define SHADINGMODELID_CLOTH\t\t\t\t8\n#define SHADINGMODELID_EYE\t\t\t\t\t9\n#define SHADINGMODELID_SINGLELAYERWATER\t\t10\n#define SHADINGMODELID_THIN_TRANSLUCENT\t\t11\n#define SHADINGMODELID_STRATA\t\t\t\t12\t\t// Temporary while we convert everything to Strata\n#define SHADINGMODELID_TOON\t\t\t\t\t13\n#define SHADINGMODELID_NUM\t\t\t\t\t14\n#define SHADINGMODELID_MASK\t\t\t\t\t0xF\t\t// 4 bits reserved for ShadingModelID\t\t\t\n\n// The flags are defined so that 0 value has no effect!\n// These occupy the 4 high bits in the same channel as the SHADINGMODELID_*\n#define HAS_ANISOTROPY_MASK\t\t\t\t(1 << 4)\n#define SKIP_PRECSHADOW_MASK\t\t\t(1 << 5)\n#define ZERO_PRECSHADOW_MASK\t\t\t(1 << 6)\n#define SKIP_VELOCITY_MASK\t\t\t\t(1 << 7)\n\n#define SSS_PROFILE_ID_INVALID  256\n#define SSS_PROFILE_ID_PERPIXEL 512\n\n// for debugging and to visualize\nfloat3 GetShadingModelColor(uint ShadingModelID)\n{\n\t// TODO: PS4 doesn't optimize out correctly the switch(), so it thinks it needs all the Samplers even if they get compiled out\n\t//\tThis will get fixed after launch per Sony...\n#if PS4_PROFILE\n\t\t if (ShadingModelID == SHADINGMODELID_UNLIT) return float3(0.1f, 0.1f, 0.2f); // Dark Blue\n\telse if (ShadingModelID == SHADINGMODELID_DEFAULT_LIT) return float3(0.1f, 1.0f, 0.1f); // Green\n\telse if (ShadingModelID == SHADINGMODELID_SUBSURFACE) return float3(1.0f, 0.1f, 0.1f); // Red\n\telse if (ShadingModelID == SHADINGMODELID_PREINTEGRATED_SKIN) return float3(0.6f, 0.4f, 0.1f); // Brown\n\telse if (ShadingModelID == SHADINGMODELID_CLEAR_COAT) return float3(0.1f, 0.4f, 0.4f); \n\telse if (ShadingModelID == SHADINGMODELID_SUBSURFACE_PROFILE) return float3(0.2f, 0.6f, 0.5f); // Cyan\n\telse if (ShadingModelID == SHADINGMODELID_TWOSIDED_FOLIAGE) return float3(0.2f, 0.2f, 0.8f); // Blue\n\telse if (ShadingModelID == SHADINGMODELID_HAIR) return float3(0.6f, 0.1f, 0.5f);\n\telse if (ShadingModelID == SHADINGMODELID_CLOTH) return float3(0.7f, 1.0f, 1.0f); \n\telse if (ShadingModelID == SHADINGMODELID_EYE) return float3(0.3f, 1.0f, 1.0f); \n\telse if (ShadingModelID == SHADINGMODELID_SINGLELAYERWATER) return float3(0.5f, 0.5f, 1.0f);\n\telse if (ShadingModelID == SHADINGMODELID_THIN_TRANSLUCENT) return float3(1.0f, 0.8f, 0.3f);\n\telse if (ShadingModelID == SHADINGMODELID_STRATA) return float3(1.0f, 1.0f, 0.0f);\n\telse if (ShadingModelID == SHADINGMODELID_TOON) return float3(0.75f, 0.1f, 0.1f);\n\telse return float3(1.0f, 1.0f, 1.0f); // White\n#else\n\tswitch(ShadingModelID)\n\t{\n\t\tcase SHADINGMODELID_UNLIT: return float3(0.1f, 0.1f, 0.2f); // Dark Blue\n\t\tcase SHADINGMODELID_DEFAULT_LIT: return float3(0.1f, 1.0f, 0.1f); // Green\n\t\tcase SHADINGMODELID_SUBSURFACE: return float3(1.0f, 0.1f, 0.1f); // Red\n\t\tcase SHADINGMODELID_PREINTEGRATED_SKIN: return float3(0.6f, 0.4f, 0.1f); // Brown\n\t\tcase SHADINGMODELID_CLEAR_COAT: return float3(0.1f, 0.4f, 0.4f); // Brown\n\t\tcase SHADINGMODELID_SUBSURFACE_PROFILE: return float3(0.2f, 0.6f, 0.5f); // Cyan\n\t\tcase SHADINGMODELID_TWOSIDED_FOLIAGE: return float3(0.2f, 0.2f, 0.8f); // Cyan\n\t\tcase SHADINGMODELID_HAIR: return float3(0.6f, 0.1f, 0.5f);\n\t\tcase SHADINGMODELID_CLOTH: return float3(0.7f, 1.0f, 1.0f);\n\t\tcase SHADINGMODELID_EYE: return float3(0.3f, 1.0f, 1.0f);\n\t\tcase SHADINGMODELID_SINGLELAYERWATER: return float3(0.5f, 0.5f, 1.0f);\n\t\tcase SHADINGMODELID_THIN_TRANSLUCENT: return float3(1.0f, 0.8f, 0.3f);\n\t\tcase SHADINGMODELID_STRATA: return float3(1.0f, 1.0f, 0.0f);\n\t\tcase SHADINGMODELID_TOON: return float3(0.75f, 0.75f, 0.1f);\n\t\tdefault: return float3(1.0f, 1.0f, 1.0f); // White\n\t}\n#endif\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br")])]),a("p",[t._v("判断是否有写入CustomData")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//DeferredShadingCommon.ush\nbool HasCustomGBufferData(int ShadingModelID)\n{\n\treturn ShadingModelID == SHADINGMODELID_SUBSURFACE\n\t\t|| ShadingModelID == SHADINGMODELID_PREINTEGRATED_SKIN\n\t\t|| ShadingModelID == SHADINGMODELID_CLEAR_COAT\n\t\t|| ShadingModelID == SHADINGMODELID_SUBSURFACE_PROFILE\n\t\t|| ShadingModelID == SHADINGMODELID_TWOSIDED_FOLIAGE\n\t\t|| ShadingModelID == SHADINGMODELID_HAIR\n\t\t|| ShadingModelID == SHADINGMODELID_CLOTH\n\t\t|| ShadingModelID == SHADINGMODELID_EYE\n\t\t|| ShadingModelID == SHADINGMODELID_TOON;\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])]),a("p",[t._v("定义写入将CustomData写入GBuffer")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//BasePassCommon.ush\n#define NEEDS_LIGHTMAP\t\t\t\t\t\t(NEEDS_LIGHTMAP_COORDINATE)\n\n#define USES_GBUFFER\t\t\t\t\t\t(FEATURE_LEVEL >= FEATURE_LEVEL_SM4 && (MATERIALBLENDING_SOLID || MATERIALBLENDING_MASKED) && !FORWARD_SHADING)\n\n// Only some shader models actually need custom data.\n#define WRITES_CUSTOMDATA_TO_GBUFFER\t\t(USES_GBUFFER && (MATERIAL_SHADINGMODEL_SUBSURFACE || MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN || MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE || MATERIAL_SHADINGMODEL_CLEAR_COAT || MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE || MATERIAL_SHADINGMODEL_HAIR || MATERIAL_SHADINGMODEL_CLOTH || MATERIAL_SHADINGMODEL_EYE || MATERIAL_SHADINGMODEL_TOON))\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("将CustomData写入GBuffer")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShadingModelsMaterial.ush\n#if MATERIAL_SHADINGMODEL_EYE\n\telse if (ShadingModel == SHADINGMODELID_EYE)\n\t{\n\t\tconst float IrisMask     = saturate(GetMaterialCustomData0(MaterialParameters));\n\t\tconst float IrisDistance = saturate(GetMaterialCustomData1(MaterialParameters));\n\n\t\tGBuffer.CustomData.x = EncodeSubsurfaceProfile(SubsurfaceProfile).x;\n\t\tGBuffer.CustomData.w = 1.0f - IrisMask;\t// Opacity\n\n\t#if IRIS_NORMAL\n\t\tfloat2 WorldNormalOct = UnitVectorToOctahedron( GBuffer.WorldNormal );\n\n\t\t// CausticNormal stored as octahedron\n\t\t#if NUM_MATERIAL_OUTPUTS_GETTANGENTOUTPUT > 0\n\t\t\t// Blend in the negative intersection normal to create some concavity\n\t\t\t// Not great as it ties the concavity to the convexity of the cornea surface\n\t\t\t// No good justification for that. On the other hand, if we're just looking to\n\t\t\t// introduce some concavity, this does the job.\n\t\t\tfloat3 PlaneNormal = normalize( GetTangentOutput0(MaterialParameters) );\n\t\t\tfloat3 CausticNormal = normalize( lerp( PlaneNormal, -GBuffer.WorldNormal, IrisMask*IrisDistance ) );\n\t\t\tfloat2 CausticNormalOct  = UnitVectorToOctahedron( CausticNormal );\n\t\t\tfloat2 CausticNormalDelta = ( CausticNormalOct - WorldNormalOct ) * 0.5 + (128.0/255.0);\n\t\t\tGBuffer.Metallic = CausticNormalDelta.x;\n\t\t\tGBuffer.Specular = CausticNormalDelta.y;\n\t\t#else\n\t\t\tfloat3 PlaneNormal = GBuffer.WorldNormal;\n\t\t\tGBuffer.Metallic = 128.0/255.0;\n\t\t\tGBuffer.Specular = 128.0/255.0;\n\t\t#endif\n\n\t\t// IrisNormal CustomData.yz\n\t\t#if NUM_MATERIAL_OUTPUTS_CLEARCOATBOTTOMNORMAL > 0\n\t\t\tfloat3 IrisNormal = normalize( ClearCoatBottomNormal0(MaterialParameters) );\n\t\t\t#if MATERIAL_TANGENTSPACENORMAL\n\t\t\t\tIrisNormal = normalize( TransformTangentVectorToWorld( MaterialParameters.TangentToWorld, IrisNormal ) );\n\t\t\t#endif\n\t\t#else\n\t\t\tfloat3 IrisNormal = PlaneNormal;\n\t\t#endif\n\n\t\tfloat2 IrisNormalOct  = UnitVectorToOctahedron( IrisNormal );\n\t\tfloat2 IrisNormalDelta = ( IrisNormalOct - WorldNormalOct ) * 0.5 + (128.0/255.0);\n\t\tGBuffer.CustomData.yz = IrisNormalDelta;\n\t#else\n\t\tGBuffer.Metallic = IrisDistance;\n\n\t\t#if NUM_MATERIAL_OUTPUTS_GETTANGENTOUTPUT > 0\n\t\t\tfloat3 Tangent = GetTangentOutput0(MaterialParameters);\n\t\t\tGBuffer.CustomData.yz = UnitVectorToOctahedron( normalize(Tangent) ) * 0.5 + 0.5;\n\t\t#endif\n\t#endif\n\n\t#if SHADING_PATH_MOBILE\n\t\t#if MATERIAL_SHADINGMODEL_EYE_USE_CURVATURE\n\t\t\tGBuffer.Curvature = Metallic;\n\t\t#else\n\t\t\tGBuffer.Curvature = CalculateCurvature(GBuffer.WorldNormal, MaterialParameters.WorldPosition_CamRelative);\n\t\t#endif\n\n\t\tGBuffer.Curvature = clamp(GBuffer.Curvature, 0.001f, 1.0f);\n\t#endif\n\t}\n#endif\n\n#if MATERIAL_SHADINGMODEL_TOON\n\telse if (ShadingModel == SHADINGMODELID_TOON)\n\t{\n\t\tGBuffer.CustomData.x = saturate( GetMaterialCustomData0(MaterialParameters) );\n\t\tGBuffer.CustomData.y = saturate( GetMaterialCustomData1(MaterialParameters) );\n\t}\n#endif\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br"),a("span",{staticClass:"line-number"},[t._v("72")]),a("br")])]),a("p",[t._v("做完了以上工作，接下来是真正对光照计算和光照模型进行修改的地方，后续对效果的调试也主要集中在这里")]),t._v(" "),a("p",[t._v("根据ShadingModelID选择BxDF")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ShadingModels.ush\nFDirectLighting IntegrateBxDF( FGBufferData GBuffer, half3 N, half3 V, half3 L, float Falloff, half NoL, FAreaLight AreaLight, FShadowTerms Shadow )\n{\n\tswitch( GBuffer.ShadingModelID )\n\t{\n\t\tcase SHADINGMODELID_DEFAULT_LIT:\n\t\tcase SHADINGMODELID_SINGLELAYERWATER:\n\t\tcase SHADINGMODELID_THIN_TRANSLUCENT:\n\t\t\treturn DefaultLitBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_SUBSURFACE:\n\t\t\treturn SubsurfaceBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_PREINTEGRATED_SKIN:\n\t\t\treturn PreintegratedSkinBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_CLEAR_COAT:\n\t\t\treturn ClearCoatBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_SUBSURFACE_PROFILE:\n\t\t\treturn SubsurfaceProfileBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_TWOSIDED_FOLIAGE:\n\t\t\treturn TwoSidedBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_HAIR:\n\t\t\treturn HairBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_CLOTH:\n\t\t\treturn ClothBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_EYE:\n\t\t\treturn EyeBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tcase SHADINGMODELID_TOON:\n\t\t\treturn ToonBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );\n\t\tdefault:\n\t\t\treturn (FDirectLighting)0;\n\t}\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br")])]),a("p",[t._v("定义BxDF")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("FDirectLighting ToonBxDF(FGBufferData GBuffer, half3 N, half3 V, half3 L, float Falloff, float NoL, FAreaLight AreaLight, FShadowTerms Shadow)\n{\n#if GBUFFER_HAS_TANGENT\n\thalf3 X = GBuffer.WorldTangent;\n\thalf3 Y = normalize(cross(N, X));\n#else\n\thalf3 X = 0;\n\thalf3 Y = 0;\n#endif\n\t\n\tBxDFContext Context;\n\tInit(Context, N, X, Y, V, L);\n\tSphereMaxNoH(Context, AreaLight.SphereSinAlpha, true);\n\tContext.NoV = saturate(abs(Context.NoV) + 1e-5);\n\n\tfloat SpecularOffset = 0.5;\n\tfloat SpecularRange = GBuffer.CustomData.x;\n\n\tfloat3 ShadowColor = 0;\n\t\n\tShadowColor = GBuffer.DiffuseColor * ShadowColor;\n\tfloat offset = GBuffer.CustomData.y;\n\tfloat SoftScatterStrength = 0;\n\n\toffset = offset * 2 - 1;\n\thalf3 H = normalize(V + L);\n\tfloat NoH = saturate(dot(N, H));\n\tNoL = (dot(N, L) + 1) / 2; // overwrite NoL to get more range out of it\n\thalf NoLOffset = saturate(NoL + offset);\n\t\n\tFDirectLighting Lighting;\n\tLighting.Diffuse = AreaLight.FalloffColor * (smoothstep(0, 1, NoLOffset) * Falloff) * Diffuse_Lambert(GBuffer.DiffuseColor) * 2.2;\n\n\tfloat InScatter = pow(saturate(dot(L, -V)), 12) * lerp(3, .1f, 1);\n\tfloat NormalContribution = saturate(dot(N, H));\n\tfloat BackScatter = GBuffer.GBufferAO * NormalContribution / (PI * 2);\n\n\tLighting.Specular = ToonStep(SpecularRange, (saturate(D_GGX(SpecularOffset, NoH)))) * (AreaLight.FalloffColor * GBuffer.SpecularColor * Falloff * 8);\n\n\tfloat3 TransmissionSoft = AreaLight.FalloffColor * (Falloff * lerp(BackScatter, 1, InScatter)) * ShadowColor * SoftScatterStrength;\n\tfloat3 ShadowLightener = (saturate(smoothstep(0, 1, saturate(1 - NoLOffset))) * ShadowColor * 0.1);\n\t\n\tLighting.Transmission = (ShadowLightener + TransmissionSoft) * Falloff;\n\treturn Lighting;\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br")])]),a("p",[t._v("更改光照的计算，主要为了实现卡通渲染的梯度衰减光照")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//DeferredLightingCommon.ush\nBRANCH\n\tif( LightMask > 0 )\n\t{\n\t\tFShadowTerms Shadow;\n\t\tShadow.SurfaceShadow = AmbientOcclusion;\n\t\tShadow.TransmissionShadow = 1;\n\t\tShadow.TransmissionThickness = 1;\n\t\tShadow.HairTransmittance.OpaqueVisibility = 1;\n\t\tconst float ContactShadowOpacity = GBuffer.CustomData.a;\n\t\tGetShadowTerms(GBuffer.Depth, GBuffer.PrecomputedShadowFactors, GBuffer.ShadingModelID, ContactShadowOpacity,\n\t\t\tLightData, TranslatedWorldPosition, L, LightAttenuation, Dither, Shadow);\n\t\tSurfaceShadow = Shadow.SurfaceShadow;\n\n\t\tLightAccumulator.EstimatedCost += 0.3f;\t\t// add the cost of getting the shadow terms\n\t\t\n\t\tfloat3 Attenuation = 1;\n\t\tBRANCH\n\t\tif (GBuffer.ShadingModelID == SHADINGMODELID_TOON)\n\t\t{\n\t\t\tfloat offset = GBuffer.CustomData.y;\n\t\t\tfloat TerminatorRange = saturate(GBuffer.Roughness - 0.5);\n\t\t\t\t\n\t\t\toffset = offset * 2 - 1;\n\t\t\t\t\n\t\t\tBRANCH\n\t\t\tif (offset >= 1)\n\t\t\t{\n\t\t\t\tAttenuation = 1;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfloat NoL = (dot(N, L) + 1) / 2;\n\t\t\t\tfloat NoLOffset = saturate(NoL + offset);\n\t\t\t\tfloat LightAttenuationOffset = saturate( Shadow.SurfaceShadow + offset);\n\t\t\t\tfloat ToonSurfaceShadow = smoothstep(0.5 - TerminatorRange, 0.5 + TerminatorRange, LightAttenuationOffset);\n\n\t\t\t\tAttenuation = smoothstep(0.5 - TerminatorRange, 0.5 + TerminatorRange, NoLOffset) * ToonSurfaceShadow;\n\t\t\t}\n\t\t}\n\n\n#if SHADING_PATH_MOBILE\n\t\tconst bool bNeedsSeparateSubsurfaceLightAccumulation = UseSubsurfaceProfile(GBuffer.ShadingModelID);\n\t\t\n\t\tFDirectLighting Lighting = (FDirectLighting)0;\n\n\t\thalf NoL = max(0, dot(GBuffer.WorldNormal, L));\n\t#if TRANSLUCENCY_NON_DIRECTIONAL\n\t\tNoL = 1.0f;\n\t#endif\n\t\tLighting = EvaluateBxDF(GBuffer, N, V, L, NoL, Shadow);\n\n\t\tLighting.Specular *= LightData.SpecularScale;\n\t\n\t\tLightAccumulator_AddSplit( LightAccumulator, Lighting.Diffuse, Lighting.Specular, Lighting.Diffuse, MaskedLightColor * Shadow.SurfaceShadow * Attenuation, bNeedsSeparateSubsurfaceLightAccumulation );\n\t\tLightAccumulator_AddSplit( LightAccumulator, Lighting.Transmission, 0.0f, Lighting.Transmission, MaskedLightColor * Shadow.TransmissionShadow, bNeedsSeparateSubsurfaceLightAccumulation );\n#else // SHADING_PATH_MOBILE\n\t\tBRANCH\n\t\tif( Shadow.SurfaceShadow + Shadow.TransmissionShadow > 0 )\n\t\t{\n\t\t\tconst bool bNeedsSeparateSubsurfaceLightAccumulation = UseSubsurfaceProfile(GBuffer.ShadingModelID);\n\n\t\t#if NON_DIRECTIONAL_DIRECT_LIGHTING\n\t\t\tfloat Lighting;\n\n\t\t\tif( LightData.bRectLight )\n\t\t\t{\n\t\t\t\tFRect Rect = GetRect( ToLight, LightData );\n\n\t\t\t\tLighting = IntegrateLight( Rect );\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tFCapsuleLight Capsule = GetCapsule( ToLight, LightData );\n\n\t\t\t\tLighting = IntegrateLight( Capsule, LightData.bInverseSquared );\n\t\t\t}\n\n\t\t\tfloat3 LightingDiffuse = Diffuse_Lambert( GBuffer.DiffuseColor ) * Lighting;\n\n\t\t\tLightAccumulator_AddSplit(LightAccumulator, LightingDiffuse, 0.0f, 0, MaskedLightColor * Shadow.SurfaceShadow * Attenuation, bNeedsSeparateSubsurfaceLightAccumulation);\n\t\t#else\n\t\t\tFDirectLighting Lighting;\n\n\t\t\tif (LightData.bRectLight)\n\t\t\t{\n\t\t\t\tFRect Rect = GetRect( ToLight, LightData );\n\t\t\t\tconst FRectTexture SourceTexture = ConvertToRectTexture(LightData);\n\n\t\t\t\t#if REFERENCE_QUALITY\n\t\t\t\t\tLighting = IntegrateBxDF( GBuffer, N, V, Rect, Shadow, SourceTexture, SVPos );\n\t\t\t\t#else\n\t\t\t\t\tLighting = IntegrateBxDF( GBuffer, N, V, Rect, Shadow, SourceTexture);\n\t\t\t\t#endif\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tFCapsuleLight Capsule = GetCapsule( ToLight, LightData );\n\n\t\t\t\t#if REFERENCE_QUALITY\n\t\t\t\t\tLighting = IntegrateBxDF( GBuffer, N, V, Capsule, Shadow, SVPos );\n\t\t\t\t#else\n\t\t\t\t\tLighting = IntegrateBxDF( GBuffer, N, V, Capsule, Shadow, LightData.bInverseSquared );\n\t\t\t\t#endif\n\t\t\t}\n\n\t\t\tLighting.Specular *= LightData.SpecularScale;\n\n\t\t\tLightAccumulator_AddSplit( LightAccumulator, Lighting.Diffuse, Lighting.Specular, Lighting.Diffuse, MaskedLightColor * Shadow.SurfaceShadow * Attenuation, bNeedsSeparateSubsurfaceLightAccumulation );\n\t\t\tLightAccumulator_AddSplit( LightAccumulator, Lighting.Transmission, 0.0f, Lighting.Transmission, MaskedLightColor * Shadow.TransmissionShadow, bNeedsSeparateSubsurfaceLightAccumulation );\n\n\t\t\tLightAccumulator.EstimatedCost += 0.4f;\t\t// add the cost of the lighting computations (should sum up to 1 form one light)\n\t\t#endif\n\t\t}\n#endif // SHADING_PATH_MOBILE\n\t}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br"),a("span",{staticClass:"line-number"},[t._v("72")]),a("br"),a("span",{staticClass:"line-number"},[t._v("73")]),a("br"),a("span",{staticClass:"line-number"},[t._v("74")]),a("br"),a("span",{staticClass:"line-number"},[t._v("75")]),a("br"),a("span",{staticClass:"line-number"},[t._v("76")]),a("br"),a("span",{staticClass:"line-number"},[t._v("77")]),a("br"),a("span",{staticClass:"line-number"},[t._v("78")]),a("br"),a("span",{staticClass:"line-number"},[t._v("79")]),a("br"),a("span",{staticClass:"line-number"},[t._v("80")]),a("br"),a("span",{staticClass:"line-number"},[t._v("81")]),a("br"),a("span",{staticClass:"line-number"},[t._v("82")]),a("br"),a("span",{staticClass:"line-number"},[t._v("83")]),a("br"),a("span",{staticClass:"line-number"},[t._v("84")]),a("br"),a("span",{staticClass:"line-number"},[t._v("85")]),a("br"),a("span",{staticClass:"line-number"},[t._v("86")]),a("br"),a("span",{staticClass:"line-number"},[t._v("87")]),a("br"),a("span",{staticClass:"line-number"},[t._v("88")]),a("br"),a("span",{staticClass:"line-number"},[t._v("89")]),a("br"),a("span",{staticClass:"line-number"},[t._v("90")]),a("br"),a("span",{staticClass:"line-number"},[t._v("91")]),a("br"),a("span",{staticClass:"line-number"},[t._v("92")]),a("br"),a("span",{staticClass:"line-number"},[t._v("93")]),a("br"),a("span",{staticClass:"line-number"},[t._v("94")]),a("br"),a("span",{staticClass:"line-number"},[t._v("95")]),a("br"),a("span",{staticClass:"line-number"},[t._v("96")]),a("br"),a("span",{staticClass:"line-number"},[t._v("97")]),a("br"),a("span",{staticClass:"line-number"},[t._v("98")]),a("br"),a("span",{staticClass:"line-number"},[t._v("99")]),a("br"),a("span",{staticClass:"line-number"},[t._v("100")]),a("br"),a("span",{staticClass:"line-number"},[t._v("101")]),a("br"),a("span",{staticClass:"line-number"},[t._v("102")]),a("br"),a("span",{staticClass:"line-number"},[t._v("103")]),a("br"),a("span",{staticClass:"line-number"},[t._v("104")]),a("br"),a("span",{staticClass:"line-number"},[t._v("105")]),a("br"),a("span",{staticClass:"line-number"},[t._v("106")]),a("br"),a("span",{staticClass:"line-number"},[t._v("107")]),a("br"),a("span",{staticClass:"line-number"},[t._v("108")]),a("br"),a("span",{staticClass:"line-number"},[t._v("109")]),a("br"),a("span",{staticClass:"line-number"},[t._v("110")]),a("br"),a("span",{staticClass:"line-number"},[t._v("111")]),a("br"),a("span",{staticClass:"line-number"},[t._v("112")]),a("br"),a("span",{staticClass:"line-number"},[t._v("113")]),a("br"),a("span",{staticClass:"line-number"},[t._v("114")]),a("br"),a("span",{staticClass:"line-number"},[t._v("115")]),a("br"),a("span",{staticClass:"line-number"},[t._v("116")]),a("br"),a("span",{staticClass:"line-number"},[t._v("117")]),a("br")])]),a("p",[t._v("同时新建了一个文件用来存放新的ShadingModel相关的自定义函数")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//ToonShadingCommon.ush\nfloat3 ToonStep(float feather, float halfLambert, float threshold = 0.5f)\n{\n\treturn smoothstep(threshold - feather, threshold + feather, halfLambert);\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("到这里应该算是已经大功告成了，已经可以在材质中连线，看到基本的卡通渲染的效果，只不过，这个效果依旧是远远不尽如人意的，如果想要做出自己心中的效果，还是得在这个框架的基础上，对光照计算改改改才行。上述的开发流程，以及光照计算的代码也参考了不少知乎上的文章，随便搜搜Shading Model的关键字就能搜到不少。而这篇文章的目的主要还是希望帮助刚开始对着代码着手开发的小伙伴，能够快速理清这整个流程和思路，以便在后续的开发中少踩一些坑。")]),t._v(" "),a("p",[t._v("这篇就这样子吧，后续应该还会写写在描边开发的过程中踩的一些坑。")])])}),[],!1,null,null,null);a.default=e.exports}}]);