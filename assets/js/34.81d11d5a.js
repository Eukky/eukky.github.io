(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{326:function(s,t,a){s.exports=a.p+"assets/img/unityshadow.ad947bba.png"},361:function(s,t,a){"use strict";a.r(t);var n=a(14),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"unity阴影渲染实现-一-unity宏阴影"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#unity阴影渲染实现-一-unity宏阴影"}},[s._v("#")]),s._v(" Unity阴影渲染实现（一）Unity宏阴影")]),s._v(" "),t("p",[s._v("这段时间使用Unity把阴影自己尝试着实现了一下。原理讲起来不难，但是在实现过程中还是踩了不少的坑。下面就让我把这段时间遇到的坑以及整个实现的过程都记录一下。本来是打算用最近在写的一个Vulkan渲染器去实现的，结果由于进度太慢连RHI都还没有封装完，想了想还是先用Unity搞一下好了。果然学习还是要一步一步慢慢来。那废话也不多说了，就开始吧。")]),s._v(" "),t("p",[s._v("既然是Unity的阴影，首先不得不提的就是Unity自带的用来渲染阴影的三个宏，分别是"),t("code",[s._v("SHADOW_COORDS")]),s._v(", "),t("code",[s._v("TRANSFER_SHADOW")]),s._v("以及"),t("code",[s._v("SHADOW_ATTENUATION")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("SHADOW_COORDS")]),s._v("用于声明一个用于对阴影纹理采样的坐标，使用方法也非常简单，直接写在"),t("code",[s._v("v2f")]),s._v("的结构体里面就可以了，例如")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("v2f")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//其他属性的声明")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//声明阴影纹理坐标")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("SHADOW_COORDS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[t("code",[s._v("TRANSFER_SHADOW")]),s._v("的实现会根据平台的不同而不同。如果当前平台支持屏幕空间的阴影映射，则会通过调用内置的"),t("code",[s._v("ComputeScreenPos")]),s._v("函数来计算"),t("code",[s._v("_ShadowCoord")]),s._v("，如果不支持屏幕空间的阴影映射，就会使用传统的阴影映射技术，通过把定点坐标从模型空间变换到光源空间，然后存储到"),t("code",[s._v("_ShadowCoord")]),s._v("中。如果我们在"),t("code",[s._v("v2f")]),s._v("结构体中使用了"),t("code",[s._v("SHADOW_COORDS")]),s._v("，只需要再在顶点着色器中直接使用"),t("code",[s._v("TRANSFER_SHADOW")]),s._v("即可")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("v2f "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a2v v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    v2f o"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//其他属性值的计算")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//转换纹理坐标")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TRANSFER_SHADOW")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("o"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" o"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[t("code",[s._v("SHADOW_ATTENUATION")]),s._v("负责使用"),t("code",[s._v("_ShadowCoord")]),s._v("对阴影相关的纹理进行采样得到阴影信息。这句宏也是直接在片元着色器中直接使用即可")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("fixed4 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("frag")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v2f i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" SV_Target "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//物体表面光照计算")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//使用内置宏对阴影进行采样")]),s._v("\n    fixed shadow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("SHADOW_ATTENUATION")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fixed4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ambient "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("diffuse "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" specular"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" atten "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" shadow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("当然，既然是宏，在使用的时候对命名也会有一些要求。为了使这些宏正确工作，需要保证"),t("code",[s._v("a2v")]),s._v("结构体中的顶点坐标命名必须为"),t("code",[s._v("vertex")]),s._v("， 顶点着色器的输入结构体"),t("code",[s._v("a2v")]),s._v("必须命名为"),t("code",[s._v("v")]),s._v("，"),t("code",[s._v("v2f")]),s._v("中的顶点位置变量必须命名为"),t("code",[s._v("pos")]),s._v("。")]),s._v(" "),t("p",[s._v("最后我们只需要在Unity编辑器当中，对想要投射阴影对物体开启"),t("code",[s._v("Cast Shadow")]),s._v("选项，对接收阴影的平面开启"),t("code",[s._v("Receive Shadows")]),s._v("选项就能渲染出阴影了。效果大概长这样子")]),s._v(" "),t("p",[t("img",{attrs:{src:a(326),alt:"unity shadow"}})]),s._v(" "),t("p",[s._v("但仅仅是这样子的话，我们自己好像啥也没有做，那么下一篇，就让我们来实现一个自定义阴影。")])])}),[],!1,null,null,null);t.default=e.exports}}]);