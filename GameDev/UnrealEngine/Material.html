<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>UE5中的卡通渲染——自定义材质编辑器 | META TECH</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
    <meta name="description" content="一个单纯的技术分享站点">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.0a53806a.js" as="script"><link rel="preload" href="/assets/js/2.e7ab5c73.js" as="script"><link rel="preload" href="/assets/js/1.924d8370.js" as="script"><link rel="preload" href="/assets/js/43.bbbbdebe.js" as="script"><link rel="prefetch" href="/assets/js/10.0ebf80ed.js"><link rel="prefetch" href="/assets/js/11.535042f9.js"><link rel="prefetch" href="/assets/js/12.d767b8a9.js"><link rel="prefetch" href="/assets/js/13.146adbc0.js"><link rel="prefetch" href="/assets/js/14.cc9595cb.js"><link rel="prefetch" href="/assets/js/15.ca33d6ee.js"><link rel="prefetch" href="/assets/js/16.422ef080.js"><link rel="prefetch" href="/assets/js/17.a2e66896.js"><link rel="prefetch" href="/assets/js/18.44dd0612.js"><link rel="prefetch" href="/assets/js/19.3dcb055b.js"><link rel="prefetch" href="/assets/js/20.c17320aa.js"><link rel="prefetch" href="/assets/js/21.3c44352c.js"><link rel="prefetch" href="/assets/js/22.88ae7534.js"><link rel="prefetch" href="/assets/js/23.58d8ab99.js"><link rel="prefetch" href="/assets/js/24.8d99dffd.js"><link rel="prefetch" href="/assets/js/25.113907d5.js"><link rel="prefetch" href="/assets/js/26.aa357591.js"><link rel="prefetch" href="/assets/js/27.091f926b.js"><link rel="prefetch" href="/assets/js/28.bf558f8e.js"><link rel="prefetch" href="/assets/js/29.30c9cdb0.js"><link rel="prefetch" href="/assets/js/3.c5d67b5d.js"><link rel="prefetch" href="/assets/js/30.446d6b4e.js"><link rel="prefetch" href="/assets/js/31.73bca2f0.js"><link rel="prefetch" href="/assets/js/32.a1d95602.js"><link rel="prefetch" href="/assets/js/33.750049c8.js"><link rel="prefetch" href="/assets/js/34.81d11d5a.js"><link rel="prefetch" href="/assets/js/35.bee0e457.js"><link rel="prefetch" href="/assets/js/36.00f8ea73.js"><link rel="prefetch" href="/assets/js/37.54fb757c.js"><link rel="prefetch" href="/assets/js/38.a6d55c54.js"><link rel="prefetch" href="/assets/js/39.5387c729.js"><link rel="prefetch" href="/assets/js/4.95c8e9af.js"><link rel="prefetch" href="/assets/js/40.c6ad81b1.js"><link rel="prefetch" href="/assets/js/41.f7eae51d.js"><link rel="prefetch" href="/assets/js/42.4b5d0a0f.js"><link rel="prefetch" href="/assets/js/44.dc21de04.js"><link rel="prefetch" href="/assets/js/45.3e2c709b.js"><link rel="prefetch" href="/assets/js/46.d470015d.js"><link rel="prefetch" href="/assets/js/47.d04a2811.js"><link rel="prefetch" href="/assets/js/48.018f9f7c.js"><link rel="prefetch" href="/assets/js/5.affefd7c.js"><link rel="prefetch" href="/assets/js/6.0ecbeb87.js"><link rel="prefetch" href="/assets/js/7.203fbb9f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.82899547.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">META TECH</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="游戏开发" class="mobile-dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GameDev/Unity/" class="nav-link">
  Unity
</a></li><li class="dropdown-item"><!----> <a href="/GameDev/UnrealEngine/" class="nav-link router-link-active">
  Unreal Engine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="APP开发" class="dropdown-title"><span class="title">APP开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="APP开发" class="mobile-dropdown-title"><span class="title">APP开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/AppDev/IOS/" class="nav-link">
  IOS
</a></li><li class="dropdown-item"><!----> <a href="/AppDev/Android/" class="nav-link">
  Android
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他站点" class="dropdown-title"><span class="title">其他站点</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他站点" class="mobile-dropdown-title"><span class="title">其他站点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://discord.gg/AVeHFqCc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/eukky/eukky.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="游戏开发" class="mobile-dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GameDev/Unity/" class="nav-link">
  Unity
</a></li><li class="dropdown-item"><!----> <a href="/GameDev/UnrealEngine/" class="nav-link router-link-active">
  Unreal Engine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="APP开发" class="dropdown-title"><span class="title">APP开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="APP开发" class="mobile-dropdown-title"><span class="title">APP开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/AppDev/IOS/" class="nav-link">
  IOS
</a></li><li class="dropdown-item"><!----> <a href="/AppDev/Android/" class="nav-link">
  Android
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他站点" class="dropdown-title"><span class="title">其他站点</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他站点" class="mobile-dropdown-title"><span class="title">其他站点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://discord.gg/AVeHFqCc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/eukky/eukky.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ue5中的卡通渲染-自定义材质编辑器"><a href="#ue5中的卡通渲染-自定义材质编辑器" class="header-anchor">#</a> UE5中的卡通渲染——自定义材质编辑器</h1> <p>继上一篇完成了描边的DrawPass之后，我们需要一个开关来随时控制材质是否进行该Pass的绘制，那么就需要自定义材质编辑器，来添加我们需要的控制开关。这个开关可以根据业务场景选择加在Component上也可以选择直接加在材质编辑器上，这里选择加在材质编辑器的实现方案。</p> <h2 id="ue中材质相关类的组织"><a href="#ue中材质相关类的组织" class="header-anchor">#</a> UE中材质相关类的组织</h2> <p>要想自定义材质编辑器的思路更加清晰，了解UE中材质相关类的组织是无论如何也不可避免的。UE中有非常多名称中带有Material的类，初看时并不容易很快理清这其中的是是非非，这里就先来简单梳理一下。</p> <ul><li>UMaterial/UMaterialInstance</li></ul> <p>这两个类是离用户最近的类，他们都是UObject，都继承自UMaterialInterface。也就是说，平时打开引擎，打开材质或者材质实例编辑器，看到的就是这两个类当中的内容，他们可以理解为专门负责引擎与用户的交互，存储用户修改的材质数据等等。</p> <p>不过需要注意的是，UMaterialInstance并不直接继承于UMaterial，我们平时继承母材质或者材质实例的操作在引擎中是通过组合的方式来进行实现的，UMaterialIntence中包含一个名称为Parent的UMaterialInterface类型的成员，这也证明了材质实例既可以直接继承母材质，也可以继承自其他的材质实例。</p> <ul><li>FMaterialResource/FMaterial</li></ul> <p>非要说的话，这两个类才是真正的材质功能类。FMaterialResource是FMaterial的子类，FMaterial中定义了大部分材质需要完成的功能，在引擎内部，材质与Shader的交互，与Pipeline的交互，大部分也都是通过FMaterial来进行实现的。FMaterialResource中实现了部分FMaterial未实现的功能，但是在目前我们未接触到FMaterial的其他子类之前，完全可以把FMaterialResource当作是FMaterial的一个完全体来看待。总之他们材质真正负责引擎内部大部分的材质相关的工作。</p> <ul><li>FMaterialRelevance</li></ul> <p>这其实是一个结构体，会发现其中包含了非常多的bool变量，他的作用可以理解为材质对渲染管线控制的一个开关集，通过一系列的标记来确定渲染某个物体时，哪些流程应该被绘制，哪些流程应该被跳过。</p> <h2 id="母材质编辑器的修改"><a href="#母材质编辑器的修改" class="header-anchor">#</a> 母材质编辑器的修改</h2> <p>一种比较方便实用的方式是，在IDE中全局搜索与想增加的属性相类似的属性，然后直接在每一个搜到的文件中添加自己的属性，工作差不多就算是完成了。</p> <p>例如我想在编辑器中添加一个<code>HasOutline</code>的勾选框，可以直接搜索<code>TwoSided</code>属性，然后照葫芦画瓢来添加代码。</p> <p>由于此处的代码非常简单，但是直接贴代码会显得非常不清晰，这里只列出一个在母材质编辑器中添加属性的通用思路。</p> <ol><li>在UMaterial以及UMaterialInstance中添加属性</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//Material.h</span>
<span class="token comment">/** Whether meshes render outline.*/</span>
<span class="token function">UPROPERTY</span><span class="token punctuation">(</span>EditAnywhere<span class="token punctuation">,</span> Category<span class="token operator">=</span>Material<span class="token punctuation">)</span>
uint8 bHasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialInstance.h</span>
uint8 bHasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>在UMaterialInterface类中声明对应的Get方法，并在UMaterial以及UMaterialInstance中重载实现</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//MaterialInterface.h</span>
ENGINE_API <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialInterface.cpp</span>
<span class="token keyword">bool</span> <span class="token class-name">UMaterialInterface</span><span class="token double-colon punctuation">::</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//Material.h</span>
ENGINE_API <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span><span class="token punctuation">;</span>

<span class="token comment">//Material.cpp</span>
<span class="token keyword">bool</span> <span class="token class-name">UMaterial</span><span class="token double-colon punctuation">::</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> bHasOutline <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//MaterialInstance.h</span>
ENGINE_API <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialInstance.cpp</span>
<span class="token keyword">bool</span> <span class="token class-name">UMaterialInstanceDynamic</span><span class="token double-colon punctuation">::</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> Parent <span class="token operator">?</span> Parent<span class="token operator">-&gt;</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ol start="3"><li>在FMaterial以及FMaterialResource中实现对应的Get方法</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//MaterialShared.h</span>
<span class="token comment">//FMaterial</span>
<span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialShared.h</span>
<span class="token comment">//FMaterialResource</span>
ENGINE_API <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialShared.h</span>
<span class="token comment">//FMaterialShaderParameters</span>
uint64 bHasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialShared.cpp</span>
<span class="token keyword">bool</span> <span class="token class-name">FMaterialResource</span><span class="token double-colon punctuation">::</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> 
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> Material<span class="token operator">-&gt;</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//MaterialShared.cpp</span>
<span class="token comment">//FMaterialShaderParameters::FMaterialShaderParameters(const FMaterial* InMaterial)</span>
bHasOutline <span class="token operator">=</span> InMaterial<span class="token operator">-&gt;</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ol start="4"><li>添加MaterialRelevence来控制渲染管线</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//MaterialRelevance.h</span>
uint8 bHasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">//SceneVisibility.cpp</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>StaticMeshRelevance<span class="token punctuation">.</span>bHasOutline<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    DrawCommandPacket<span class="token punctuation">.</span><span class="token function">AddCommandsForMesh</span><span class="token punctuation">(</span>PrimitiveIndex<span class="token punctuation">,</span> PrimitiveSceneInfo<span class="token punctuation">,</span> StaticMeshRelevance<span class="token punctuation">,</span> StaticMesh<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> bCanCache<span class="token punctuation">,</span> EMeshPass<span class="token double-colon punctuation">::</span>OutlinePass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//SceneCore.h</span>
<span class="token comment">//FStaticMeshBatchRelevance</span>
uint8 bHasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">//PrimitiveSceneInfo.cpp</span>
<span class="token comment">//virtual void DrawMesh(const FMeshBatch&amp; Mesh, float ScreenSize) final override</span>
<span class="token keyword">bool</span> bHasOutline <span class="token operator">=</span> Material<span class="token punctuation">.</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

FStaticMeshBatchRelevance<span class="token operator">*</span> StaticMeshRelevance <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span>PrimitiveSceneInfo<span class="token operator">-&gt;</span>StaticMeshRelevances<span class="token punctuation">)</span> <span class="token function">FStaticMeshBatchRelevance</span><span class="token punctuation">(</span>
    <span class="token operator">*</span>StaticMesh<span class="token punctuation">,</span> 
    ScreenSize<span class="token punctuation">,</span> 
    bSupportsCachingMeshDrawCommands<span class="token punctuation">,</span>
    bUseSkyMaterial<span class="token punctuation">,</span>
    bUseSingleLayerWaterMaterial<span class="token punctuation">,</span>
    bUseAnisotropy<span class="token punctuation">,</span>
    bSupportsNaniteRendering<span class="token punctuation">,</span>
    bSupportsGPUScene<span class="token punctuation">,</span>
    bHasOutline<span class="token punctuation">,</span>
    FeatureLevel
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>其实母材质编辑器的修改到这里已经差不多了，如果有什么遗漏的地方，可以按照全局搜索相似的属性来做一遍校对，问题也不大，做完之后会发现母材质编辑器的细节面板会多出一个Outline的勾选框，选中之后即可在渲染管线中开启OutlinePass。</p> <h2 id="材质实例编辑器的修改"><a href="#材质实例编辑器的修改" class="header-anchor">#</a> 材质实例编辑器的修改</h2> <p>但是仅仅只修改母材质的编辑器还远远不够，很多材质的微调都是在材质实例上实现的，然而在材质实例的编辑器上实现对应的按钮相对来说要更复杂一些，因为他的面板并不是直接调用反射根据类中的成员自动生成的，而是需要我们自己去绘制相对应的UI布局。</p> <p>当然接着上面的情况，我们需要首先把材质实例相关部分的实现也给补齐。同样由于这部分的改写虽然复杂但是没有太大难度，这里也只列出一个通用流程。</p> <ol><li>在FMaterialInstanceBasePropertyOverrides中添加对应的属性，来应对材质实例重写母材质参数的情况</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//MaterialInstanceBasePropertyOverrides.h</span>
<span class="token comment">/** Enables override of Outline property. */</span>
<span class="token function">UPROPERTY</span><span class="token punctuation">(</span>EditAnywhere<span class="token punctuation">,</span> Category <span class="token operator">=</span> Material<span class="token punctuation">)</span>
uint8 bOverride_HasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/** Indicates that the material should be rendered with outline. */</span>
<span class="token function">UPROPERTY</span><span class="token punctuation">(</span>EditAnywhere<span class="token punctuation">,</span> Category <span class="token operator">=</span> Material<span class="token punctuation">,</span> meta <span class="token operator">=</span> <span class="token punctuation">(</span>editcondition <span class="token operator">=</span> <span class="token string">&quot;bOverride_HasOutline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
uint8 HasOutline <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>在FMaterialInstanceParameterDetails中添加相关的函数</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//MaterialEditorInstanceDetailCustomization.h</span>
<span class="token keyword">bool</span> <span class="token function">OverrideEnableOutlineEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">OnOverrideEnableOutlineEnabled</span><span class="token punctuation">(</span><span class="token keyword">bool</span> NewValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//MaterialEditorInstanceDetailCustomization.cpp</span>
<span class="token keyword">bool</span> <span class="token class-name">FMaterialInstanceParameterDetails</span><span class="token double-colon punctuation">::</span><span class="token function">OverrideEnableOutlineEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> MaterialEditorInstance<span class="token operator">-&gt;</span>BasePropertyOverrides<span class="token punctuation">.</span>bOverride_HasOutline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FMaterialInstanceParameterDetails</span><span class="token double-colon punctuation">::</span><span class="token function">OnOverrideEnableOutlineEnabled</span><span class="token punctuation">(</span><span class="token keyword">bool</span> NewValue<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	MaterialEditorInstance<span class="token operator">-&gt;</span>BasePropertyOverrides<span class="token punctuation">.</span>bOverride_HasOutline <span class="token operator">=</span> NewValue<span class="token punctuation">;</span>
	MaterialEditorInstance<span class="token operator">-&gt;</span><span class="token function">PostEditChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	FEditorSupportDelegates<span class="token double-colon punctuation">::</span>RedrawAllViewports<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="3"><li>在FMaterialInstanceParameterDetails中编写界面</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//MaterialEditorInstanceDetailCustomization.cpp</span>
<span class="token comment">//void FMaterialInstanceParameterDetails::CreateBasePropertyOverrideWidgets(IDetailLayoutBuilder&amp; DetailLayout, IDetailGroup&amp; MaterialPropertyOverrideGroup)</span>

TAttribute<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> IsOVerrideEnableOutlineEnabled <span class="token operator">=</span> <span class="token class-name">TAttribute</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>TAttribute<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token class-name">FGetter</span><span class="token double-colon punctuation">::</span><span class="token function">CreateSP</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FMaterialInstanceParameterDetails<span class="token double-colon punctuation">::</span>OverrideEnableOutlineEnabled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

TSharedPtr<span class="token operator">&lt;</span>IPropertyHandle<span class="token operator">&gt;</span> EnableOutlineProperty <span class="token operator">=</span> BasePropertyOverridePropery<span class="token operator">-&gt;</span><span class="token function">GetChildHandle</span><span class="token punctuation">(</span><span class="token string">&quot;HasOutline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">{</span>
    FIsResetToDefaultVisible IsEnableOutlinePropertyResetVisible <span class="token operator">=</span> <span class="token class-name">FIsResetToDefaultVisible</span><span class="token double-colon punctuation">::</span><span class="token function">CreateLambda</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>TSharedPtr<span class="token operator">&lt;</span>IPropertyHandle<span class="token operator">&gt;</span> InHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> MaterialEditorInstance<span class="token operator">-&gt;</span>Parent <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">?</span> MaterialEditorInstance<span class="token operator">-&gt;</span>BasePropertyOverrides<span class="token punctuation">.</span>HasOutline <span class="token operator">!=</span> MaterialEditorInstance<span class="token operator">-&gt;</span>Parent<span class="token operator">-&gt;</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FResetToDefaultHandler ResetEnableOutlinePropertyHandler <span class="token operator">=</span> <span class="token class-name">FResetToDefaultHandler</span><span class="token double-colon punctuation">::</span><span class="token function">CreateLambda</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>TSharedPtr<span class="token operator">&lt;</span>IPropertyHandle<span class="token operator">&gt;</span> InHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MaterialEditorInstance<span class="token operator">-&gt;</span>Parent <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            MaterialEditorInstance<span class="token operator">-&gt;</span>BasePropertyOverrides<span class="token punctuation">.</span>HasOutline <span class="token operator">=</span> MaterialEditorInstance<span class="token operator">-&gt;</span>Parent<span class="token operator">-&gt;</span><span class="token function">HasOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FResetToDefaultOverride ResetEnableOutlinePropertyOverride <span class="token operator">=</span> <span class="token class-name">FResetToDefaultOverride</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>IsEnableOutlinePropertyResetVisible<span class="token punctuation">,</span> ResetEnableOutlinePropertyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IDetailPropertyRow<span class="token operator">&amp;</span> EnableOutlinePropertyRow <span class="token operator">=</span> BasePropertyOverrideGroup<span class="token punctuation">.</span><span class="token function">AddPropertyRow</span><span class="token punctuation">(</span>EnableOutlineProperty<span class="token punctuation">.</span><span class="token function">ToSharedRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EnableOutlinePropertyRow
        <span class="token punctuation">.</span><span class="token function">DisplayName</span><span class="token punctuation">(</span>EnableOutlineProperty<span class="token operator">-&gt;</span><span class="token function">GetPropertyDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToolTip</span><span class="token punctuation">(</span>EnableOutlineProperty<span class="token operator">-&gt;</span><span class="token function">GetToolTipText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">EditCondition</span><span class="token punctuation">(</span>IsOVerrideEnableOutlineEnabled<span class="token punctuation">,</span> <span class="token class-name">FOnBooleanValueChanged</span><span class="token double-colon punctuation">::</span><span class="token function">CreateSP</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FMaterialInstanceParameterDetails<span class="token double-colon punctuation">::</span>OnOverrideEnableOutlineEnabled<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Visibility</span><span class="token punctuation">(</span><span class="token class-name">TAttribute</span><span class="token operator">&lt;</span>EVisibility<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>TAttribute<span class="token operator">&lt;</span>EVisibility<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token class-name">FGetter</span><span class="token double-colon punctuation">::</span><span class="token function">CreateSP</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FMaterialInstanceParameterDetails<span class="token double-colon punctuation">::</span>IsOverriddenAndVisible<span class="token punctuation">,</span> IsOVerrideEnableOutlineEnabled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">OverrideResetToDefault</span><span class="token punctuation">(</span>ResetEnableOutlinePropertyOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>这样一来，材质实例的编辑器也就定制好了。掌握了这个流程之后，可以根据自己的需求在其中添加更多的选项来扩展自己的功能，例如描边的颜色，描边的粗细程度等，之后将材质实例中获取的这些参数传入Shader，一个在材质实例自由控制的描边功能就算是完成了。</p> <p>最后，离上一篇更新已经过去了许久，现在发现工程类型的文章其实也没有那么好写，不写代码实现，原理往往非常简单，写了代码实现，文章又会显得十分冗余，这次就尝试把一个通用的思路提取出来，不知道能不能帮到对UE感兴趣的朋友们。</p> <p>这次就先这样子吧。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/eukky/eukky.github.io/edit/dev/docs/GameDev/UnrealEngine/Material.md" target="_blank" rel="noopener noreferrer">Edit</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0a53806a.js" defer></script><script src="/assets/js/2.e7ab5c73.js" defer></script><script src="/assets/js/1.924d8370.js" defer></script><script src="/assets/js/43.bbbbdebe.js" defer></script>
  </body>
</html>
