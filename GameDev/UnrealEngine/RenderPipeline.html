<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>UE5渲染管线概览 | META TECH</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
    <meta name="description" content="一个单纯的技术分享站点">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.0a53806a.js" as="script"><link rel="preload" href="/assets/js/2.e7ab5c73.js" as="script"><link rel="preload" href="/assets/js/1.924d8370.js" as="script"><link rel="preload" href="/assets/js/29.30c9cdb0.js" as="script"><link rel="prefetch" href="/assets/js/10.0ebf80ed.js"><link rel="prefetch" href="/assets/js/11.535042f9.js"><link rel="prefetch" href="/assets/js/12.d767b8a9.js"><link rel="prefetch" href="/assets/js/13.146adbc0.js"><link rel="prefetch" href="/assets/js/14.cc9595cb.js"><link rel="prefetch" href="/assets/js/15.ca33d6ee.js"><link rel="prefetch" href="/assets/js/16.422ef080.js"><link rel="prefetch" href="/assets/js/17.a2e66896.js"><link rel="prefetch" href="/assets/js/18.44dd0612.js"><link rel="prefetch" href="/assets/js/19.3dcb055b.js"><link rel="prefetch" href="/assets/js/20.c17320aa.js"><link rel="prefetch" href="/assets/js/21.3c44352c.js"><link rel="prefetch" href="/assets/js/22.88ae7534.js"><link rel="prefetch" href="/assets/js/23.58d8ab99.js"><link rel="prefetch" href="/assets/js/24.8d99dffd.js"><link rel="prefetch" href="/assets/js/25.113907d5.js"><link rel="prefetch" href="/assets/js/26.aa357591.js"><link rel="prefetch" href="/assets/js/27.091f926b.js"><link rel="prefetch" href="/assets/js/28.bf558f8e.js"><link rel="prefetch" href="/assets/js/3.c5d67b5d.js"><link rel="prefetch" href="/assets/js/30.446d6b4e.js"><link rel="prefetch" href="/assets/js/31.73bca2f0.js"><link rel="prefetch" href="/assets/js/32.a1d95602.js"><link rel="prefetch" href="/assets/js/33.750049c8.js"><link rel="prefetch" href="/assets/js/34.81d11d5a.js"><link rel="prefetch" href="/assets/js/35.bee0e457.js"><link rel="prefetch" href="/assets/js/36.00f8ea73.js"><link rel="prefetch" href="/assets/js/37.54fb757c.js"><link rel="prefetch" href="/assets/js/38.a6d55c54.js"><link rel="prefetch" href="/assets/js/39.5387c729.js"><link rel="prefetch" href="/assets/js/4.95c8e9af.js"><link rel="prefetch" href="/assets/js/40.c6ad81b1.js"><link rel="prefetch" href="/assets/js/41.f7eae51d.js"><link rel="prefetch" href="/assets/js/42.4b5d0a0f.js"><link rel="prefetch" href="/assets/js/43.bbbbdebe.js"><link rel="prefetch" href="/assets/js/44.dc21de04.js"><link rel="prefetch" href="/assets/js/45.3e2c709b.js"><link rel="prefetch" href="/assets/js/46.d470015d.js"><link rel="prefetch" href="/assets/js/47.d04a2811.js"><link rel="prefetch" href="/assets/js/48.018f9f7c.js"><link rel="prefetch" href="/assets/js/5.affefd7c.js"><link rel="prefetch" href="/assets/js/6.0ecbeb87.js"><link rel="prefetch" href="/assets/js/7.203fbb9f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.82899547.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">META TECH</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="游戏开发" class="mobile-dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GameDev/Unity/" class="nav-link">
  Unity
</a></li><li class="dropdown-item"><!----> <a href="/GameDev/UnrealEngine/" class="nav-link router-link-active">
  Unreal Engine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="APP开发" class="dropdown-title"><span class="title">APP开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="APP开发" class="mobile-dropdown-title"><span class="title">APP开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/AppDev/IOS/" class="nav-link">
  IOS
</a></li><li class="dropdown-item"><!----> <a href="/AppDev/Android/" class="nav-link">
  Android
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他站点" class="dropdown-title"><span class="title">其他站点</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他站点" class="mobile-dropdown-title"><span class="title">其他站点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://discord.gg/AVeHFqCc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/eukky/eukky.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="游戏开发" class="mobile-dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GameDev/Unity/" class="nav-link">
  Unity
</a></li><li class="dropdown-item"><!----> <a href="/GameDev/UnrealEngine/" class="nav-link router-link-active">
  Unreal Engine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="APP开发" class="dropdown-title"><span class="title">APP开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="APP开发" class="mobile-dropdown-title"><span class="title">APP开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/AppDev/IOS/" class="nav-link">
  IOS
</a></li><li class="dropdown-item"><!----> <a href="/AppDev/Android/" class="nav-link">
  Android
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他站点" class="dropdown-title"><span class="title">其他站点</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他站点" class="mobile-dropdown-title"><span class="title">其他站点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://discord.gg/AVeHFqCc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/eukky/eukky.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ue5渲染管线概览"><a href="#ue5渲染管线概览" class="header-anchor">#</a> UE5渲染管线概览</h1> <p>这段时间元宇宙大火，又恰逢UE5的第一个正式版发布，无论是游戏行业还是其他的什么Web3.0都搞得风风火火，作为互联网的赶潮儿，怎么能不跟上这股潮流。这次就来学习一下UE5吧。</p> <p>不过从哪儿开始呢，作为一个UE萌新，直接上手太难的部分也不太适合，那就先看看UE引以为豪的渲染管线吧。但是想必很多新手都和我一样有一个困惑，那就是UE的代码量这么大，该怎么找到我想看的东西在哪儿呢，别急别急，看渲染当然是要从截帧开始啦。那就让我们先截个帧吧。</p> <h2 id="renderdoc寻找入口"><a href="#renderdoc寻找入口" class="header-anchor">#</a> RenderDoc寻找入口</h2> <p>这里使用的是ue5-main分支。</p> <p>随便新建一个空项目，在插件中打开RenderDoc插件，点击右上角的截帧按钮截帧，没几秒就截出来了。先来看看这一帧当中，UE都做了些啥事。下图是筛选了draw关键字之后的结果。</p> <p><img src="/assets/img/RenderDocPass.a614b770.png" alt="RenderDocPass"></p> <p>可以看到在Scene这个Pass下面就是整个场景的渲染了，接下来就是根据这张图来找到对应的代码都在什么位置了。随便找个不容易重名的pass名称，在VS中进行全局搜索，这里我就搜一个BasePass下面的BasePassParallel，找到一个AddPass的地方，打上断点，返回UE，发现断点立马就被触发了，那么接下来我们就可以根据堆栈来进行整个渲染管线的分析了。</p> <p>断点位置与堆栈调用信息如下图所示</p> <p><img src="/assets/img/BasePassParallel.12d0d664.png" alt="BasePassParallel"></p> <p>逐级查看调用堆栈，会发现在<code>RenderViewFamily_RenderThread(FRHICommandListImmediate&amp; RHICmdList, FSceneRenderer* SceneRenderer)</code>这个函数中，有这样一段代码</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>ViewFamily<span class="token punctuation">.</span>EngineShowFlags<span class="token punctuation">.</span>HitProxies<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Render the scene's hit proxies.</span>
    SceneRenderer<span class="token operator">-&gt;</span><span class="token function">RenderHitProxies</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bAnyShowHitProxies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Render the scene.</span>
    SceneRenderer<span class="token operator">-&gt;</span><span class="token function">Render</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
GraphBuilder<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>很显然，这里就是整个UE整个场景渲染的入口了。这里主要有三条函数，下面两条看名称就非常容易理解，分别是场景渲染RDG的配置以及RDG的执行，而第一条RenderHitProxies，查阅官方文档对这个标志位的描述是这样的</p> <blockquote><p>HitProxies: Draws each hit proxy in the scene with a different color, for now only available in the editor</p></blockquote> <p>也就是说这是在编辑器模式下渲染场景中的碰撞相关的东西，显然并不是我们这次需要关心的事情。那么事情可以向前再进一步，我们只需要进入Render函数进行分析就可以了。</p> <p>由于这次调试是在PC上进行调试，所以这个SceneRenderer的类型是FDeferredShadingSceneRenderer，也就是UE最通用的延迟渲染管线，如果是启用了Mobile管线，便会进入Mobile管线的Render函数。</p> <p>那么就先来看看这个延迟渲染管线中又做了一些什么事吧。</p> <h2 id="延迟渲染管线"><a href="#延迟渲染管线" class="header-anchor">#</a> 延迟渲染管线</h2> <p>如果代码跳转不好用，我们可以打个断点F11进去。总之现在我们已经找到了这个函数。</p> <p>Render是一个1400多行的大函数，各个pass的具体的执行操作也没有在这个函数中展开，如果细细看定会需要花上不少的时间，这次我们不求细节，来草草看看里面大概做了哪些事情。</p> <p>官方文档中有针对UE4版本的FDeferredShadingSceneRenderer::Render()函数相关的说明，尽管这个文档暂时并没有更新至UE5的版本，但是依旧能够给我们提供一些参考。文档的链接如下</p> <p>https://docs.unrealengine.com/5.0/zh-CN/graphics-programming-overview-for-unreal-engine/</p> <p>那么现在就正式开始来探究这个庞大的渲染函数吧。</p> <p>官网文档中提及我们可以直接寻找对应的渲染事件来依次查看对应的实现，那么首先需要寻找的，就是Scene这个事件了，这是整个场景渲染的开始位置。而搜索一番之后，确实可以在函数中找到这么一行</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_EVENT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token string">&quot;Scene&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么从这一行可以得到这样两个信息</p> <ol><li>UE使用RDG_EVENT_SCOPE()这个宏来定义渲染事件。</li> <li>以这行为为界，可以将整个Render函数分为两个部分，上半部分是对一些模块的初始化以及配置，下半部分是执行场景的渲染。</li></ol> <p>那么先来看看上面的配置部分都做了哪些事吧。</p> <h3 id="渲染配置"><a href="#渲染配置" class="header-anchor">#</a> 渲染配置</h3> <p>把上半部分一些相对重要的操作提炼出来，可以大致把函数浓缩成下面这样</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//下方代码只为更加直观总结出每个阶段所做的操作，省去了部分判断逻辑与宏的使用，不保证代码逻辑与源码相同</span>
<span class="token comment">//需要详细了解每个部分的细节还请移步源码</span>

<span class="token comment">//查看Nanite是否启用</span>
<span class="token keyword">const</span> <span class="token keyword">bool</span> bNaniteEnabled <span class="token operator">=</span> <span class="token function">IsNaniteEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//刷新RayTracing相关的Cache和资源</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">RHI_RAYTRACING</span></span>
    Scene<span class="token operator">-&gt;</span><span class="token function">RefreshRayTracingMeshCommandCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Scene<span class="token operator">-&gt;</span><span class="token function">RefreshRayTracingInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">//初始化每个View的Shader相关资源</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>int32 ViewIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ViewIndex <span class="token operator">&lt;</span> Views<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ViewIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ShaderPrint</span><span class="token double-colon punctuation">::</span><span class="token function">BeginView</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ShadingEnergyConservation</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ShaderPrint</span><span class="token double-colon punctuation">::</span><span class="token function">EndView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//更新所有场景资源</span>
Scene<span class="token operator">-&gt;</span><span class="token function">UpdateAllPrimitiveSceneInfos</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Nanite资源的同步与更新</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bNaniteEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Nanite<span class="token double-colon punctuation">::</span>GGlobalResources<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Nanite<span class="token double-colon punctuation">::</span>GStreamingManager<span class="token punctuation">.</span><span class="token function">BeginAsyncUpdate</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    FNaniteVisualizationData<span class="token operator">&amp;</span> NaniteVisualization <span class="token operator">=</span> <span class="token function">GetNaniteVisualizationData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NaniteVisualization<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>NaniteViewMode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//设置最终渲染的View区域</span>
<span class="token function">PrepareViewRectsForRendering</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">.</span>RHICmdList<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//天空大气渲染设置</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldRenderSkyAtmosphere</span><span class="token punctuation">(</span>Scene<span class="token punctuation">,</span> ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bPathTracedAtmosphere<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int32 LightIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> LightIndex <span class="token operator">&lt;</span> NUM_ATMOSPHERE_LIGHTS<span class="token punctuation">;</span> <span class="token operator">++</span>LightIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PrepareSunLightProxy</span><span class="token punctuation">(</span><span class="token operator">*</span>Scene<span class="token operator">-&gt;</span><span class="token function">GetSkyAtmosphereSceneInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>LightIndex<span class="token punctuation">,</span> <span class="token operator">*</span>Scene<span class="token operator">-&gt;</span>AtmosphereLights<span class="token punctuation">[</span>LightIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Scene<span class="token operator">-&gt;</span><span class="token function">ResetAtmosphereLightsProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//Multi GPU相关设置</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">WITH_MGPU</span></span>
<span class="token keyword">const</span> FRHIGPUMask RenderTargetGPUMask <span class="token operator">=</span> <span class="token function">ComputeGPUMasks</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">.</span>RHICmdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">//等待遮挡测试</span>
<span class="token function">WaitOcclusionTests</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">.</span>RHICmdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="场景渲染"><a href="#场景渲染" class="header-anchor">#</a> 场景渲染</h3> <p>从这里开始，RDG的宏能够为我们分析这段代码提供不少帮助。依旧还是从上到下，我们按顺序去看每一段代码都在做什么。为了方便快速检索代码，下边也会把源码给贴出来。</p> <ul><li>给RT分配内存</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_Render_Init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RDG_RHI_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> AllocateRendertargets<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize global system textures (pass-through if already initialized).</span>
GSystemTextures<span class="token punctuation">.</span><span class="token function">InitializeTextures</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">.</span>RHICmdList<span class="token punctuation">,</span> FeatureLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Force the subsurface profile texture to be updated.</span>
<span class="token function">UpdateSubsurfaceProfileTexture</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> ShaderPlatform<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Force the rect light texture to be updated.</span>
<span class="token class-name">RectLightAtlas</span><span class="token double-colon punctuation">::</span><span class="token function">UpdateRectLightAtlasTexture</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> FeatureLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>更新VT</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> VirtualTextureUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// AllocateResources needs to be called before RHIBeginScene</span>
<span class="token class-name">FVirtualTextureSystem</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllocateResources</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> FeatureLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FVirtualTextureSystem</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CallPendingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">VirtualTextureFeedbackBegin</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTexturesConfig<span class="token punctuation">.</span>Extent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>初始化可见性</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> VisibilityCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">InitViews</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTexturesConfig<span class="token punctuation">,</span> BasePassDepthStencilAccess<span class="token punctuation">,</span> ILCTaskData<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>为UniformBufferExtension准备视图</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>IPersistentViewUniformBufferExtension<span class="token operator">*</span> Extension <span class="token operator">:</span> PersistentViewUniformBufferExtensions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Extension<span class="token operator">-&gt;</span><span class="token function">BeginFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int32 ViewIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ViewIndex <span class="token operator">&lt;</span> Views<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ViewIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Extension<span class="token operator">-&gt;</span><span class="token function">PrepareView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Views<span class="token punctuation">[</span>ViewIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>为使用路径追踪进行渲染准备资源</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Gather mesh instances, shaders, resources, parameters, etc. and build ray tracing acceleration structure</span>
FRayTracingScene<span class="token operator">&amp;</span> RayTracingScene <span class="token operator">=</span> Scene<span class="token operator">-&gt;</span>RayTracingScene<span class="token punctuation">;</span>
RayTracingScene<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> int32 ReferenceViewIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
FViewInfo<span class="token operator">&amp;</span> ReferenceView <span class="token operator">=</span> Views<span class="token punctuation">[</span>ReferenceViewIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Prepare the scene for rendering this frame.</span>
<span class="token function">GatherRayTracingWorldInstancesForView</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> ReferenceView<span class="token punctuation">,</span> RayTracingScene<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>提交动态VB</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_FGlobalDynamicVertexBuffer_Commit<span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicIndexBufferForInitViews<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicVertexBufferForInitViews<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicReadBufferForInitViews<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>特效的预渲染，包括GPU粒子模拟等</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_FXSystem_PreRender<span class="token punctuation">)</span><span class="token punctuation">;</span>
GraphBuilder<span class="token punctuation">.</span><span class="token function">SetCommandListStat</span><span class="token punctuation">(</span><span class="token function">GET_STATID</span><span class="token punctuation">(</span>STAT_CLM_FXPreRender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
FXSystem<span class="token operator">-&gt;</span><span class="token function">PreRender</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*bAllowGPUParticleUpdate*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>FGPUSortManager<span class="token operator">*</span> GPUSortManager <span class="token operator">=</span> FXSystem<span class="token operator">-&gt;</span><span class="token function">GetGPUSortManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GPUSortManager<span class="token operator">-&gt;</span><span class="token function">OnPreRender</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>场景GPU资源的更新，包括Instance数据的更新和剔除，物理场的更新等</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> GPUSceneUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
Scene<span class="token operator">-&gt;</span>GPUScene<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token operator">*</span>Scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
Scene<span class="token operator">-&gt;</span><span class="token function">UpdatePhysicsField</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>再一次更新VT，与上一次不同的是，上一次VT的更新主要还是处理资源的分配，这里是真正的对VT数据进行更新。</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> VirtualTextureUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FVirtualTextureSystem</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> FeatureLevel<span class="token punctuation">,</span> Scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>判断是否进行光源剔除</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsSimpleForwardShadingEnabled</span><span class="token punctuation">(</span>ShaderPlatform<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bComputeLightGrid <span class="token operator">|=</span> <span class="token punctuation">(</span>
        <span class="token function">ShouldRenderVolumetricFog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">VolumetricCloudWantsToSampleLocalLights</span><span class="token punctuation">(</span>Scene<span class="token punctuation">,</span> ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">)</span> <span class="token operator">||</span>
        ActiveViewFamily<span class="token operator">-&gt;</span>ViewMode <span class="token operator">!=</span> VMI_Lit <span class="token operator">||</span>
        bAnyLumenEnabled <span class="token operator">||</span>
        ActiveViewFamily<span class="token operator">-&gt;</span>VirtualShadowMapArray<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>判断是否进行遮挡剔除与深度测试</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">bool</span> bIsOcclusionTesting <span class="token operator">=</span> <span class="token function">DoOcclusionQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">.</span>DisableOcclusionQueries
    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">.</span>Wireframe <span class="token operator">||</span> bIsViewFrozen <span class="token operator">||</span> bHasViewParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">bool</span> bNeedsPrePass <span class="token operator">=</span> <span class="token function">ShouldRenderPrePass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>绘制深度</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>DepthPass<span class="token punctuation">.</span><span class="token function">IsComputeStencilDitherEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AddDitheredStencilFillPass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> DepthPass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>发丝相关的计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsHairStrandsEnabled</span><span class="token punctuation">(</span>EHairStrandsShaderType<span class="token double-colon punctuation">::</span>All<span class="token punctuation">,</span> Scene<span class="token operator">-&gt;</span><span class="token function">GetShaderPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bRunHairStrands<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RunHairStrandsBookmark</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> EHairStrandsBookmark<span class="token double-colon punctuation">::</span>ProcessStrandsInterpolation<span class="token punctuation">,</span> HairStrandsBookmarkParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>FViewInfo<span class="token operator">&amp;</span> View <span class="token operator">:</span> Views<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            View<span class="token punctuation">.</span>HairStrandsViewData<span class="token punctuation">.</span>UniformBuffer <span class="token operator">=</span> <span class="token class-name">HairStrands</span><span class="token double-colon punctuation">::</span><span class="token function">CreateDefaultHairStrandsViewUniformBuffer</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>更新Nanite Streaming</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>bUpdateNaniteStreaming<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Nanite<span class="token double-colon punctuation">::</span>GStreamingManager<span class="token punctuation">.</span><span class="token function">EndAsyncUpdate</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>距离场的计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_RHI_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> GPUSceneUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PrepareDistanceFieldScene</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>Prepass深度剔除</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>GraphBuilder<span class="token punctuation">.</span><span class="token function">SetCommandListStat</span><span class="token punctuation">(</span><span class="token function">GET_STATID</span><span class="token punctuation">(</span>STAT_CLM_PrePass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bNeedsPrePass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RenderPrePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// We didn't do the prepass, but we still want the HMD mask if there is one</span>
    <span class="token function">RenderPrePassHMD</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>Lumen相关的可见性计算与动态VB设置，在InitViewsAfterPrepass()函数中主要进行动态阴影初始化，反射探针Buffer设置等。</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>FLumenSceneFrameTemporaries LumenFrameTemporaries<span class="token punctuation">;</span>

<span class="token function">RDG_RHI_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> VisibilityCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">InitViewsAfterPrepass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">,</span> ILCTaskData<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_FGlobalDynamicVertexBuffer_Commit<span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicVertexBufferForInitShadows<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicIndexBufferForInitShadows<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicReadBufferForInitShadows<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>Nanite光栅化与剔除</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token class-name">Nanite</span><span class="token double-colon punctuation">::</span><span class="token function">CullRasterize</span><span class="token punctuation">(</span>
    GraphBuilder<span class="token punctuation">,</span>
    Scene<span class="token operator">-&gt;</span>NaniteRasterPipelines<span class="token punctuation">[</span>ENaniteMeshPass<span class="token double-colon punctuation">::</span>BasePass<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token operator">*</span>Scene<span class="token punctuation">,</span>
    View<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> PackedView <span class="token punctuation">}</span><span class="token punctuation">,</span>
    SharedContext<span class="token punctuation">,</span>
    CullingContext<span class="token punctuation">,</span>
    RasterContext<span class="token punctuation">,</span>
    RasterState<span class="token punctuation">,</span>
    <span class="token comment">/*OptionalInstanceDraws*/</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
    bExtractStats
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>Resolve Depth，这个Pass只会在启用MSAA的情况下执行</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">AddResolveSceneDepthPass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>光源排序，遮挡剔除，与剔除后的光照计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SortLights<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">GatherLightsAndComputeLightGrid</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> bComputeLightGrid<span class="token punctuation">,</span> SortedLightSet<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">RenderOcclusion</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> bIsOcclusionTesting<span class="token punctuation">)</span><span class="token punctuation">;</span>

CompositionLighting<span class="token punctuation">.</span><span class="token function">ProcessAfterOcclusion</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>距离场阴影投影计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">BeginAsyncDistanceFieldShadowProjections</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>体积云，天空大气与实时环境反射相关初始化</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">InitVolumetricRenderTargetForViews</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">InitVolumetricCloudsForViews</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> bShouldRenderVolumetricCloudBase<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">RenderSkyAtmosphereLookUpTables</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

Scene<span class="token operator">-&gt;</span><span class="token function">AllocateAndCaptureFrameSkyEnvMap</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> MainView<span class="token punctuation">,</span> bShouldRenderSkyAtmosphere<span class="token punctuation">,</span> bShouldRenderVolumetricCloud<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>自定义深度计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderCustomDepthPass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>CustomDepth<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span><span class="token function">GetSceneTextureShaderParameters</span><span class="token punctuation">(</span>FeatureLevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>Lumen场景更新，主要包括光照贴图的渲染等</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">UpdateLumenScene</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>在前向渲染的情况下，渲染阴影深度，头发，以及阴影投影，以及体积雾</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsForwardShadingEnabled</span><span class="token punctuation">(</span>ShaderPlatform<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RenderShadowDepthMaps</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bHairStrandsEnable <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bHasRayTracedOverlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RenderHairPrePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RenderHairBasePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">RenderForwardShadowProjections</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> ForwardScreenSpaceShadowMaskTexture<span class="token punctuation">,</span> ForwardScreenSpaceShadowMaskHairTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ComputeVolumetricFog</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>DBuffer相关的处理，主要包括DBuffer贴花的计算与SSAO</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>CompositionLighting<span class="token punctuation">.</span><span class="token function">ProcessBeforeBasePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> DBufferTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>前向渲染的情况下，IndirectCapsuleShadows的绘制</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsForwardShadingEnabled</span><span class="token punctuation">(</span>ShaderPlatform<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bAllowStaticLighting<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">RenderIndirectCapsuleShadows</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>BasePass，场景中物件的渲染，主要绘制各物件的GBuffer</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderBasePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> DBufferTextures<span class="token punctuation">,</span> BasePassDepthStencilAccess<span class="token punctuation">,</span> ForwardScreenSpaceShadowMaskTexture<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">,</span> bNaniteEnabled<span class="token punctuation">,</span> NaniteRasterResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>Nanite可视化</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token class-name">Nanite</span><span class="token double-colon punctuation">::</span><span class="token function">AddVisualizationPasses</span><span class="token punctuation">(</span>
    GraphBuilder<span class="token punctuation">,</span>
    Scene<span class="token punctuation">,</span>
    SceneTextures<span class="token punctuation">,</span>
    ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">,</span>
    Views<span class="token punctuation">,</span>
    NaniteRasterResults
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>实时天空球捕获</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>bRealTimeSkyCaptureEnabled<span class="token punctuation">)</span><span class="token punctuation">{</span>
    Scene<span class="token operator">-&gt;</span><span class="token function">ValidateSkyLightRealTimeCapture</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>体积光可视化</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">VisualizeVolumetricLightmap</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果在BasePass之前没有做遮挡剔除与光照计算，则在这里做</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bOcclusionBeforeBasePass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RenderOcclusionLambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>Resolve Scene Color，同样只在MSAA开启的情况下进行</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">AddResolveSceneColorPass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果是非前向渲染，则头发的渲染在这里进行</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>bHairStrandsEnable <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsForwardShadingEnabled</span><span class="token punctuation">(</span>ShaderPlatform<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bHasRayTracedOverlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RenderHairPrePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RenderHairBasePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>BasePass之后的阴影深度，Lumen光照以及体积雾计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderShadowDepthMaps</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderLumenSceneLighting</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ComputeVolumetricFog</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>Nanite Streaming请求递交</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Nanite<span class="token double-colon punctuation">::</span>GStreamingManager<span class="token punctuation">.</span><span class="token function">SubmitFrameStreamingRequests</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>BasePass之后的Custom Depth绘制</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>CustomDepthPassLocation <span class="token operator">==</span> ECustomDepthPassLocation<span class="token double-colon punctuation">::</span>AfterBasePass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RenderCustomDepthPass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>CustomDepth<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span><span class="token function">GetSceneTextureShaderParameters</span><span class="token punctuation">(</span>FeatureLevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>Velocity的渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderVelocities</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> EVelocityPass<span class="token double-colon punctuation">::</span>Opaque<span class="token punctuation">,</span> bHairStrandsEnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>延迟渲染的光照合成，贴花，以及SSAO</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">CSV_SCOPED_TIMING_STAT_EXCLUSIVE</span><span class="token punctuation">(</span>AfterBasePass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_AfterBasePass<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsForwardShadingEnabled</span><span class="token punctuation">(</span>ShaderPlatform<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AddResolveSceneDepthPass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

CompositionLighting<span class="token punctuation">.</span><span class="token function">ProcessAfterBasePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>等待路径追踪的光照计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">WaitForRayTracingScene</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> DynamicGeometryScratchBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>Lumen光照计算，包括间接光照，AO，天空光，发丝次表面散射等计算</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> RenderDeferredLighting<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RDG_CSV_STAT_EXCLUSIVE_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> RenderLighting<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_Lighting<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">BeginGatheringLumenSurfaceCacheFeedback</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderDiffuseIndirectAndAmbientOcclusion</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">,</span> LightingChannelsTexture<span class="token punctuation">,</span> <span class="token comment">/* bIsVisualizePass = */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderIndirectCapsuleShadows</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderDFAOAsIndirectShadowing</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> DynamicBentNormalAOTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderLights</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> TranslucencyLightingVolumeTextures<span class="token punctuation">,</span> LightingChannelsTexture<span class="token punctuation">,</span> SortedLightSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderDeferredReflectionsAndSkyLighting</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> DynamicBentNormalAOTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderGlobalIlluminationPluginVisualizations</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> LightingChannelsTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">AddSubsurfacePass</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> Views<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderHairStrandsSceneColorScattering</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> Views<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>环境的渲染，包括光束的渲染，大气的渲染，雾的渲染以及体积云的渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Draw Lightshafts</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bHasRayTracedOverlay <span class="token operator">&amp;&amp;</span> ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">.</span>LightShafts<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_RenderLightShaftOcclusion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LightShaftOcclusionTexture <span class="token operator">=</span> <span class="token function">RenderLightShaftOcclusion</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Draw the sky atmosphere</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bHasRayTracedOverlay <span class="token operator">&amp;&amp;</span> bShouldRenderSkyAtmosphere<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_RenderSkyAtmosphere<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RenderSkyAtmosphere</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Draw fog.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bHasRayTracedOverlay <span class="token operator">&amp;&amp;</span> <span class="token function">ShouldRenderFog</span><span class="token punctuation">(</span><span class="token operator">*</span>ActiveViewFamily<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">RDG_CSV_STAT_EXCLUSIVE_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> RenderFog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_RenderFog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RenderFog</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> LightShaftOcclusionTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// After the height fog, Draw volumetric clouds (having fog applied on them already) when using per pixel tracing,</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bHasRayTracedOverlay <span class="token operator">&amp;&amp;</span> bShouldRenderVolumetricCloud<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> bSkipVolumetricRenderTarget <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> bSkipPerPixelTracing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">RenderVolumetricCloud</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> bSkipVolumetricRenderTarget<span class="token punctuation">,</span> bSkipPerPixelTracing<span class="token punctuation">,</span> HalfResolutionDepthCheckerboardMinMaxTexture<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>不透明特效的渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderOpaqueFX</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> FXSystem<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>UniformBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>透明Pass之前，发丝的合成</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetHairStrandsComposition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EHairStrandsCompositionType<span class="token double-colon punctuation">::</span>BeforeTranslucent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> HairRendering<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RenderHairComposition</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>透明Pass</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_EVENT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token string">&quot;Translucency&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderTranslucency</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> TranslucencyLightingVolumeTextures<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TranslucencyResourceMap<span class="token punctuation">,</span> TranslucencyViewsToRender<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>透明Pass之后，发丝的合成</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetHairStrandsComposition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EHairStrandsCompositionType<span class="token double-colon punctuation">::</span>AfterTranslucent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> HairRendering<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RenderHairComposition</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>Distortion的渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>GraphBuilder<span class="token punctuation">.</span><span class="token function">SetCommandListStat</span><span class="token punctuation">(</span><span class="token function">GET_STATID</span><span class="token punctuation">(</span>STAT_CLM_Distortion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderDistortion</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Depth<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>透明物体的Velosity渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>GraphBuilder<span class="token punctuation">.</span><span class="token function">SetCommandListStat</span><span class="token punctuation">(</span><span class="token function">GET_STATID</span><span class="token punctuation">(</span>STAT_CLM_TranslucentVelocity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderVelocities</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> EVelocityPass<span class="token double-colon punctuation">::</span>Translucent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>Shader Debug信息的绘制</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>FViewInfo<span class="token operator">&amp;</span> View <span class="token operator">:</span> Views<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ShadingEnergyConservation</span><span class="token double-colon punctuation">::</span><span class="token function">Debug</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>光线Bloom的渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_FDeferredShadingSceneRenderer_RenderLightShaftBloom<span class="token punctuation">)</span><span class="token punctuation">;</span>
GraphBuilder<span class="token punctuation">.</span><span class="token function">SetCommandListStat</span><span class="token punctuation">(</span><span class="token function">GET_STATID</span><span class="token punctuation">(</span>STAT_CLM_LightShaftBloom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderLightShaftBloom</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> <span class="token comment">/* inout */</span> TranslucencyResourceMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>路径追踪以及路径追踪的Debug信息</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderPathTracing</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>UniformBuffer<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderRayTracingDebug</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>物理场渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderPhysicsField</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Views<span class="token punctuation">,</span> Scene<span class="token operator">-&gt;</span>PhysicsField<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">.</span>Color<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>距离场光照渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderDistanceFieldLighting</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> <span class="token function">FDistanceFieldAOParameters</span><span class="token punctuation">(</span>OcclusionMaxDistance<span class="token punctuation">)</span><span class="token punctuation">,</span> DummyOutput<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ActiveViewFamily<span class="token operator">-&gt;</span>EngineShowFlags<span class="token punctuation">.</span>VisualizeDistanceFieldAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>网格距离场可视化</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderMeshDistanceFieldVisualization</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> <span class="token function">FDistanceFieldAOParameters</span><span class="token punctuation">(</span>Scene<span class="token operator">-&gt;</span>DefaultMaxDistanceFieldOcclusionDistance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>间接光AO</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderLumenMiscVisualizations</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RenderDiffuseIndirectAndAmbientOcclusion</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">,</span> LightingChannelsTexture<span class="token punctuation">,</span> <span class="token comment">/* bIsVisualizePass = */</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>重叠光源渲染</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RenderStationaryLightOverlap</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> SceneTextures<span class="token punctuation">,</span> LightingChannelsTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>后处理</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">RDG_EVENT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> <span class="token string">&quot;PostProcessing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RDG_GPU_STAT_SCOPE</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> Postprocessing<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">AddPostProcessingPasses</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">,</span> View<span class="token punctuation">,</span> ViewIndex<span class="token punctuation">,</span> bAnyLumenActive<span class="token punctuation">,</span> PostProcessingInputs<span class="token punctuation">,</span> NaniteResults<span class="token punctuation">,</span> InstanceCullingManager<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ActiveViewFamily<span class="token operator">-&gt;</span>VirtualShadowMapArray<span class="token punctuation">,</span> LumenFrameTemporaries<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>到这里整个场景的渲染基本上就算是结束了，可以发现这个函数里面包含了非常多的逻辑，有些渲染根据配置不同前前后后反复出现，例如Depth贴图的绘制等等，根据是否开启PreZ，是否是前向渲染还是延迟渲染，都会被放到不同的地方去执行，上面对整个函数逻辑的摘抄只为了解个大概，毕竟每一个阶段的调用函数进去之后，又是一个个可以深入研究的话题。</p> <p>同时，把关键代码摘抄出来，也方便日后进行某一个模块开发的时候直接对源码位置进行一个定位，不过这就是后面的话题了。</p> <p>不过总的来说，整个渲染流程中调用的东西可以分为这几个模块</p> <ul><li>延迟管线的绘制</li> <li>前向管线的绘制</li> <li>路径追踪管线的渲染</li> <li>Lumen的配置与渲染</li> <li>Nanite的配置与渲染</li> <li>场景环境光照（天空，大气，云）的配置与渲染</li></ul> <p>对整个渲染流程的粗略一看，免不了会有错误和疏漏，但是也不要紧，看完之后还是能够知道UE5在渲染中大概去做了哪些事情。出了这个延迟渲染管线，UE5中还包含一个Mobile管线，这里就不作分析了。</p> <p>另外，对于是否要把使用RenderDoc寻找源码的切入点给写出来，其实纠结了蛮久，最终还是打算写一下。我相信还是有不少朋友在最开始想要学习UE源码时在茫茫代码中不知从哪里去找自己想看的那部分，也不知道如何上手。这里就当作是给像我一样不知道从哪儿开始的朋友们做个参考。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/eukky/eukky.github.io/edit/dev/docs/GameDev/UnrealEngine/RenderPipeline.md" target="_blank" rel="noopener noreferrer">Edit</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0a53806a.js" defer></script><script src="/assets/js/2.e7ab5c73.js" defer></script><script src="/assets/js/1.924d8370.js" defer></script><script src="/assets/js/29.30c9cdb0.js" defer></script>
  </body>
</html>
